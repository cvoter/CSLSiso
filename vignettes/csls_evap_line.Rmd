---
title: "Isotope Evaporation Line"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(CSLSiso)
library(CSLSdata)
library(dplyr) #for pipes, filtering, and selecting
library(stringr) #for str_c
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(lubridate)
library(knitr)
```


```{r data, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
calculate_line_intersect <- function(line1, line2){
  x <- (line1$coefficients[1] - line2$coefficients[1])/
       (line2$coefficients[2] - line1$coefficients[2])
  y <- line1$coefficients[2]*x + line1$coefficients[1]
  line_intersect <- data.frame(x = x, y = y)
  return(line_intersect)
}

dist_to_point <- function(x1, y1, x2, y2){
  dist <- sqrt((x2 - x1)^2 - (y2 - y1))
  return(dist)
}

get_del_atm <- function(ltmp, del_pcpn) {
    alpha    <- d18O_evap_isotope_frac(ltmp)
    del_atm <- d18O_evap_d18O_atm(del_pcpn, alpha)
    return(del_atm)
}
```

## Overview

When looking at the **Local Meteoric Water Line** plots, keep in mind that
measurements closest to the meteoric water line are most likely inflowing
groundwater wells while measurements drifting off to the right are likely
outflowing groundwater wells (or the lake itself), which are influenced by
evaporation.

```{r schematic2, out.width = "75%", eval=TRUE, echo=FALSE, fig.align="center"}
include_graphics(system.file("images", 
                             "isotope_signatures.png", 
                             package = "isoH2Obudget", 
                             mustWork = TRUE))
```

## Local Evaporation Line

This looks great, just as expected. All lakes fall along the same local
evaporation line.

```{r LEWL, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, fig.align="center"}
dictionary <- rbind(cslsdata::dictionary[["Pleasant"]],
                    cslsdata::dictionary[["Plainfield"]],
                    cslsdata::dictionary[["Long"]])
isotopes   <- rbind(cslsdata::isotopes[["Pleasant"]],
                    cslsdata::isotopes[["Plainfield"]],
                    cslsdata::isotopes[["Long"]])
lake_ids      <- dictionary %>%
                 filter(.data$obs_type == "LK") %>%
                 select(.data$site_id)
lake_isotopes <- isotopes %>%
                 filter(as.character(.data$site_id) %in% 
                          as.character(lake_ids$site_id))
pcpn_isotopes <- isotopes %>%
                 filter(.data$site_id == "PRECIP")
LMWL <- lm(d2H ~ d18O, pcpn_isotopes)
LEWL <- lm(d2H ~ d18O, lake_isotopes)

line_intersect     <- calculate_line_intersect(LMWL, LEWL)
lake_isotopes$dist <- dist_to_point(line_intersect$x, line_intersect$y,
                                    lake_isotopes$d18O, lake_isotopes$d2H)
lake_isotopes$date <- floor_date(lake_isotopes$date, unit = "month")

# Local Evaporation Line
ggplot() +
  geom_smooth(data = pcpn_isotopes, 
              aes(x = d18O, y = d2H), 
              method = "lm") +
  geom_smooth(data = lake_isotopes, 
              aes(x = d18O, y = d2H), 
              method = "lm") +
  geom_point(data = line_intersect, 
             aes(x = x, y = y), 
             size = 3) +
  geom_point(data = lake_isotopes, 
             aes(x = d18O, y = d2H, color = lake), 
             size = 3) +
  labs(title = "Local Evaporation Line") +
  theme_bw() +
  theme(text = element_text(family = "Segoe UI Semilight"))

```

```{r inputs, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, fig.align="center"}
# Get Lake Inputs and Water Balance
lake <- "Pleasant"
psnt_inputs      <- runall_csls_inputs(lake)
psnt_inputs$lake <- lake
psnt_h2o         <- calculate_h2o_bal(psnt_inputs)
psnt_h2o$lake    <- lake

lake <- "Long"
long_inputs      <- runall_csls_inputs(lake)
long_inputs$lake <- lake
long_h2o         <- calculate_h2o_bal(long_inputs)
long_h2o$lake    <- lake

lake <- "Plainfield"
pfl_inputs      <- runall_csls_inputs(lake)
pfl_inputs$lake <- lake
pfl_h2o         <- calculate_h2o_bal(pfl_inputs)
pfl_h2o$lake    <- lake

h2o    <- rbind(pfl_h2o, psnt_h2o, long_h2o)
inputs <- rbind(pfl_inputs, psnt_inputs, long_inputs)

# Add in del_atm
inputs$d18O_atm <- get_del_atm(inputs$ltmp_K, inputs$d18O_pcpn)
inputs$d2H_atm  <- get_del_atm(inputs$ltmp_K, inputs$d2H_pcpn)

# Fit line to del_evap and del_atm
del_evap <- lm(d2H_evap ~ d18O_evap, inputs)
del_atm  <- lm(d2H_atm ~ d18O_atm, inputs)
```

## Position on Local Evaporation Line vs. GWin

I think the position (i.e., distance) on the LEL should be proportional to the
ratio of evaporation to total inflow (P + GWin), or EtoIn.

$$ EtoIn = \frac{E}{P + GW_{in}}$$

But can we estimate GWin just by knowing P, Evap, and del_lake? Maybe there's
not a direct relationship here.

```{r plot, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, fig.align="center"}
# Calculate Relationship Between 
h2o$date <- floor_date(h2o$date, unit = "month")
lake_isotopes <- merge(lake_isotopes, h2o, by = c("date","lake"))
lake_isotopes$EtoIn_m3 <- lake_isotopes$E_m3/(lake_isotopes$P_m3 + lake_isotopes$GWin_m3)

# # Water Balance
# kable(subset(h2o, is.na(GWin) == FALSE), caption = "Complete water budgets")
sorted_isotopes <- lake_isotopes %>%
                   filter(is.na(GWin_m3) == FALSE) %>%
                   select(date, lake, P_m3, E_m3, GWin_m3, dist, EtoIn_m3) %>%
                   arrange(.data$dist)

kable(sorted_isotopes)

# Relationship between isotopes and evap/inputs?
ggplot(data = lake_isotopes, aes(x = dist, y = EtoIn_m3, color = site_id)) +
  geom_point(size = 3) +
  geom_text(aes(label = date), hjust=-0.1, vjust=0) +
  labs(x = "Distance to Intersect", y = "E / (P + GWin)",
       title = "Relationship between relative isotope compostion and evap/inputs") +
  theme_bw() +
  theme(text = element_text(family = "Segoe UI Semilight"))

```

## Calculated Atm and Evap Isotopic Composition

Also plotted del_atm and del_evap to compare to Figure 3b in Gibson et al.,
2016. This is not quite right. Would expect del_evap (topmost line) to simply
extend the local evaporation line, and would expect del_atm to be pretty similar
(but with a slightly shallower slope) than the del_precip line. 

The slopes on these lines seem right.

But the lines are shifted higher than expected. My first thought was that I had
accidentally used d18O values instead of d2H values for precipitation and the
lake in the d2H evap calculations, but I've double checked this and that's not
happening.

Not sure how much to worry about this, probably just need to move on.

```{r del_evap, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, fig.align="center"}
# del_evap and del_atm
ggplot() +
  geom_smooth(data = pcpn_isotopes, 
              aes(x = d18O, y = d2H), 
              method = "lm") +
  geom_smooth(data = lake_isotopes, 
              aes(x = d18O, y = d2H), 
              method = "lm") +
  geom_smooth(data = inputs, 
              aes(x = d18O_evap, y = d2H_evap), 
              method = "lm") +
  geom_smooth(data = inputs, 
              aes(x = d18O_atm, y = d2H_atm), 
              method = "lm") +
  geom_point(data = line_intersect, 
             aes(x = x, y = y), 
             size = 3) +
  geom_point(data = inputs, 
             aes(x = d18O_atm, y = d2H_atm, color = lake),
             size = 3) +
  geom_point(data = inputs, 
             aes(x = d18O_evap, y = d2H_evap, color = lake),
             size = 3) +
  geom_point(data = lake_isotopes, 
             aes(x = d18O, y = d2H, color = lake), 
             size = 3) +
  labs(title = "Add in del_evap and del_atm") +
  theme_bw() +
  theme(text = element_text(family = "Segoe UI Semilight"))

```

```{r LMWL}
isotopes$site_type <- NA
for (i in 1:nrow(isotopes)) {
  site_type             <- dictionary %>%
                           filter(as.character(.data$site_id) == 
                                    as.character(isotopes$site_id[i])) %>%
                           select(.data$obs_type)
  isotopes$site_type[i] <- as.character(site_type$obs_type[1])
}

colnames(line_intersect) <- c("d18O", "d2H")
lake_isotopes <- bind_rows(lake_isotopes, line_intersect)

fig1 <- ggplot() +
        geom_smooth(data = pcpn_isotopes, 
                    aes(x = d18O, y = d2H), 
                    method = "lm",
                    color = "black") +
        geom_point(data = subset(isotopes, site_type == "P"), 
                   aes(x = d18O,
                       y = d2H,
                       color = site_type,
                       shape = lake),
                   size = 4) +
        scale_y_continuous(limits = c(-100, -26)) +
        scale_x_continuous(limits = c(-15, -2)) +
        scale_shape_manual(name = "Location",
                           breaks = c("Hancock"),
                           labels = c("Precipitation"),
                           values = c(19)) +
        scale_color_manual(name = "Source Type",
                           breaks = c("P"),
                           labels = c("Precipitation"),
                           values = c("#1F78B4")) +
       labs(x = expression(paste(delta^{18}, "O ", "(\211)")), 
            y = expression(paste(delta^{2}, "H ", "(\211)"))) +
       guides(color = guide_legend(order = 1),
              shape = guide_legend(order = 2)) +
       theme_bw() +
       theme(text = element_text(family = "Segoe UI Semilight",
                                 size = text_size),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank())

fig2 <- ggplot() +
        geom_smooth(data = pcpn_isotopes, 
                    aes(x = d18O, y = d2H), 
                    method = "lm",
                    color = "black") +
        geom_smooth(data = lake_isotopes, 
                    aes(x = d18O, y = d2H), 
                    method = "lm",
                    color = "black") +
        geom_point(data = subset(isotopes, site_type != "GW"), 
                   aes(x = d18O,
                       y = d2H,
                       color = site_type,
                       shape = lake),
                   size = 4) +
        scale_y_continuous(limits = c(-100, -26)) +
        scale_x_continuous(limits = c(-15, -2)) +
        scale_shape_manual(name = "Location",
                           breaks = c("Hancock", "Pleasant", "Long",
                                      "Plainfield"),
                           labels = c("Precipitation", "Pleasant", "Long", 
                                      "Plainfield"),
                           values = c(19, 18, 17, 15)) +
        scale_color_manual(name = "Source Type",
                           breaks = c("P", "LK"),
                           labels = c("Precipitation", "Lake"),
                           values = c("#FB9A99", "#1F78B4")) +
       labs(x = expression(paste(delta^{18}, "O ", "(\211)")), 
            y = expression(paste(delta^{2}, "H ", "(\211)"))) +
       guides(color = guide_legend(order = 1),
              shape = guide_legend(order = 2)) +
       theme_bw() +
       theme(text = element_text(family = "Segoe UI Semilight",
                                 size = text_size),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank())

fig2b <- ggplot() +
        geom_smooth(data = pcpn_isotopes, 
                    aes(x = d18O, y = d2H), 
                    method = "lm",
                    color = "black") +
        geom_point(data = subset(isotopes, site_type != "LK"), 
                   aes(x = d18O,
                       y = d2H,
                       color = site_type,
                       shape = lake),
                   size = 4) +
        scale_y_continuous(limits = c(-100, -26)) +
        scale_x_continuous(limits = c(-15, -2)) +
        scale_shape_manual(name = "Location",
                           breaks = c("Hancock", "Pleasant", "Long",
                                      "Plainfield"),
                           labels = c("Precipitation", "Pleasant", "Long", 
                                      "Plainfield"),
                           values = c(19, 18, 17, 15)) +
        scale_color_manual(name = "Source Type",
                           breaks = c("P", "GW"),
                           labels = c("Precipitation", "Groundwater"),
                           values = c("#33A02C", "#1F78B4")) +
       labs(x = expression(paste(delta^{18}, "O ", "(\211)")), 
            y = expression(paste(delta^{2}, "H ", "(\211)"))) +
       guides(color = guide_legend(order = 1),
              shape = guide_legend(order = 2)) +
       theme_bw() +
       theme(text = element_text(family = "Segoe UI Semilight",
                                 size = text_size),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank())

fig3 <- ggplot() +
        geom_smooth(data = pcpn_isotopes, 
                    aes(x = d18O, y = d2H), 
                    method = "lm",
                    color = "black") +
        geom_smooth(data = lake_isotopes, 
                    aes(x = d18O, y = d2H), 
                    method = "lm",
                    color = "black") +
        geom_point(data = isotopes, 
                   aes(x = d18O,
                       y = d2H,
                       color = site_type,
                       shape = lake),
                   size = 4) +
        scale_y_continuous(limits = c(-100, -26)) +
        scale_x_continuous(limits = c(-15, -2)) +
        scale_shape_manual(name = "Location",
                           breaks = c("Hancock", "Pleasant", "Long",
                                      "Plainfield"),
                           labels = c("Precipitation", "Pleasant", "Long", 
                                      "Plainfield"),
                           values = c(19, 18, 17, 15)) +
        scale_color_manual(name = "Source Type",
                           breaks = c("P", "GW", "LK"),
                           labels = c("Precipitation", "Groundwater", "Lake"),
                           values = c("#33A02C", "#FB9A99", "#1F78B4")) +
       labs(x = expression(paste(delta^{18}, "O ", "(\211)")), 
            y = expression(paste(delta^{2}, "H ", "(\211)"))) +
       guides(color = guide_legend(order = 1),
              shape = guide_legend(order = 2)) +
       theme_bw() +
       theme(text = element_text(family = "Segoe UI Semilight",
                                 size = text_size),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank())
        
```

## Session Info

The version of R and the versions of packages in use when this R Markdown file
was created are listed here:

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
