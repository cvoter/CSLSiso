---
title: "CSLS Isotope Sensitivity Exploration"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(cslsdata)
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(dplyr) #for %>% pipes
```

```{r fcns, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 3}
lake_sensitivity <- function(lake){
  data("weather", package = "cslsdata")
    if (lake == "Pleasant") {
      data("psnt_lst", package = "cslsdata"); lst <- psnt_lst
      data("psnt_isotopes", package = "cslsdata"); isotopes <- psnt_isotopes
      data("psnt_lake_levels", package = "cslsdata"); lake_levels <- psnt_lake_levels
      data("psnt_gw_levels", package = "cslsdata"); gw_levels <- psnt_gw_levels
      data("psnt_stage_vol", package = "cslsdata"); stage_vol <- psnt_stage_vol
      data("psnt_dictionary", package = "cslsdata"); site_dictionary <- psnt_dictionary
    } else if (lake == "Long") {
      data("long_lst", package = "cslsdata"); lst <- long_lst
      data("long_isotopes", package = "cslsdata"); isotopes <- long_isotopes
      data("long_lake_levels", package = "cslsdata"); lake_levels <- long_lake_levels
      data("long_gw_levels", package = "cslsdata"); gw_levels <- long_gw_levels
      data("long_stage_vol", package = "cslsdata"); stage_vol <- long_stage_vol
      data("long_dictionary", package = "cslsdata"); site_dictionary <- long_dictionary
    } else if (lake == "Plainfield") {
      data("pfl_lst", package = "cslsdata"); lst <- pfl_lst
      data("pfl_isotopes", package = "cslsdata"); isotopes <- pfl_isotopes
      data("pfl_lake_levels", package = "cslsdata"); lake_levels <- pfl_lake_levels
      data("pfl_gw_levels", package = "cslsdata"); gw_levels <- pfl_gw_levels
      data("pfl_stage_vol", package = "cslsdata"); stage_vol <- pfl_stage_vol
      data("pfl_dictionary", package = "cslsdata"); site_dictionary <- pfl_dictionary
    }
  
  h2o_bal_default <- summarise_h2o_bal(lake, weather, lst, isotopes, lake_levels, gw_levels,
                                       site_dictionary, stage_vol, 
                                       static_gw = FALSE, median_threshold = 0.01, 
                                       static_lake = FALSE, 
                                       use_kniffin_pcpn = TRUE)
  h2o_bal_gw <- summarise_h2o_bal(lake, weather, lst, isotopes, lake_levels, gw_levels,
                                       site_dictionary, stage_vol, 
                                       static_gw = TRUE, median_threshold = 0.01, 
                                       static_lake = FALSE, 
                                       use_kniffin_pcpn = TRUE)
  h2o_bal_lake <- summarise_h2o_bal(lake, weather, lst, isotopes, lake_levels, gw_levels,
                                       site_dictionary, stage_vol, 
                                       static_gw = FALSE, median_threshold = 0.01, 
                                       static_lake = TRUE, 
                                       use_kniffin_pcpn = TRUE)
  h2o_bal_both <- summarise_h2o_bal(lake, weather, lst, isotopes, lake_levels, gw_levels,
                                       site_dictionary, stage_vol, 
                                       static_gw = TRUE, median_threshold = 0.01, 
                                       static_lake = TRUE, 
                                       use_kniffin_pcpn = TRUE)
  
  # Combine
  h2o_bal_default$static <- "Dynamic"
  h2o_bal_gw$static      <- "S-GW"
  h2o_bal_lake$static    <- "S-Lake"
  h2o_bal_both$static    <- "Static"
  
  h2o_bal_combo <- rbind(h2o_bal_default, h2o_bal_gw, h2o_bal_lake, h2o_bal_both)
  h2o_bal_combo <- select(h2o_bal_combo, c(date, static, GWin))
  h2o_bal_combo <- h2o_bal_combo[order(h2o_bal_combo$date),]
  h2o_bal_combo <- subset(h2o_bal_combo, is.na(GWin) == FALSE)
  h2o_bal_combo
  
  return(h2o_bal_combo)
}

plot_sensitivity <- function(lake, h2o_bal_combo) {
  h2o_bal_melt     <- melt(h2o_bal_combo, id.vars = c("date", "static"))
  plot_sensitivity <- ggplot(data = h2o_bal_melt) +
    geom_col(aes(x = static, y = value, fill = static)) +
    facet_grid(~as.Date(date), scales = "fixed") +
    scale_y_continuous(expand = c(0,0)) +
    theme_bw() + 
    labs(x = "", 
         y = "GW Inflow (mm)", 
         title = sprintf("%s Lake", lake)) +
    guides(fill = FALSE) +
    theme(text = element_text(family = "Segoe UI Semilight"))
  return(plot_sensitivity)
}
```

## Sensitivity to Isotope Measurements

To explore how sensitive this water balance is to the groundwater and lake
isotope measurements, this compares the water balance calculated with:

1. **Dynamic** definitions of well upgradient/downgradient and lake isotope
measurements. Upgradient wells are determined based on 30-day daily differences in lake and gw levels. Lake measurements for the month of interest are used when available, otherwise the fall measurement (from Oct 2018) is used.
2. **Static well** upgradient/downgradient definitions. Water levels are not
used to determine upgradient/downgradient wells, we just use a pre-defined set
of wells for all months.
3. **Static lake** measurement. Use Oct 2018 measurement for all months.
4. **Both** static well and static lake definitions

### Overall

**The GW approach** only matters at Long Lake in the spring, i.e., where and
when the flip in gw levels is most dramatic.

**The Lake approach** matters substantially in the spring. At all lakes, GWin is
>60% lower when calculated using fall (Oct 2018) values vs. with measured spring
(Apr 2019) values.

### Pleasant Lake

At this lake, the GW approach does not affect the final water balance at any
time during the year.

Using fall (Oct 2018) lake measurements in the spring (April 2019) reduces GWin
by 66%.

```{r psnt, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 3}
lake <- "Pleasant"
h2o_bal_combo <- lake_sensitivity(lake)
plot_sensitivity(lake, h2o_bal_combo)
```

### Long Lake 
Only using wells that from a pre-determined list of "upgradient" wells in the
spring (April 2019) reduces GWin by 14.5%. There is no difference in the fall or
winter.

Using fall (Oct 2018) lake measurements in the spring (April 2019) reduces GWin
by 63%.

```{r long, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 3}
lake <- "Long"
h2o_bal_combo <- lake_sensitivity(lake)
plot_sensitivity(lake, h2o_bal_combo)
```

### Plainfield Lake
At this lake, the GW approach does not affect the final water balance at any
time during the year.

Using fall (Oct 2018) lake measurements in the spring (April 2019) reduces GWin
by 64%.

```{r pfl, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 3}
lake <- "Plainfield"
h2o_bal_combo <- lake_sensitivity(lake)
plot_sensitivity(lake, h2o_bal_combo)
```
