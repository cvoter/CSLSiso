---
title: "CSLS Isotope Sensitivity Exploration"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(cslsdata)
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(dplyr) #for %>% pipes
library(lubridate) #for month
library(forcats)
```

```{r fcns, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 3}
iso_sensitivity <- function(lake){
  h2o_bal_default <- runall_csls_budget(lake)
  h2o_bal_gw      <- runall_csls_budget(lake, static_gw = TRUE)
  h2o_bal_lake    <- runall_csls_budget(lake, static_lake = TRUE)
  h2o_bal_knif    <- runall_csls_budget(lake, extend_pcpn = FALSE)
  h2o_bal_csls    <- runall_csls_budget(lake, use_kniffin_pcpn = FALSE)
  
  h2o_bal_default$case <- "Default"
  h2o_bal_gw$case      <- "GW"
  h2o_bal_lake$case    <- "LK"
  h2o_bal_knif$case    <- "KNF"
  h2o_bal_csls$case    <- "CSLS"

  h2o_bal <- rbind(h2o_bal_default, 
                   subset(h2o_bal_gw, case != "Default"), 
                   subset(h2o_bal_lake, case != "Default"), 
                   subset(h2o_bal_knif, case != "Default"),
                   subset(h2o_bal_csls, case != "Default"))
  h2o_bal <- h2o_bal %>%
             filter(is.na(GWin_m3) == FALSE,
                    month(date) != 12) %>%
             arrange(date) %>%
             select(date, case, GWin_m3)
  
  h2o_bal$case <- fct_relevel(h2o_bal$case, c("Default", "GW", "LK", "KNF", 
                                              "CSLS"))
  
  h2o_bal_melt     <- melt(h2o_bal, id.vars = c("date", "case"))
  
  plot_sensitivity <- ggplot(data = h2o_bal_melt) +
                      geom_col(aes(x = case, y = value, fill = case)) +
                      facet_wrap(~as.Date(date), scales = "fixed") +
                      scale_y_continuous(expand = c(0,0)) +
                      theme_bw() + 
                      labs(x = "", 
                           y = "GW Inflow (m^3)", 
                           title = sprintf("%s Lake", lake)) +
                      guides(fill = FALSE) +
                      theme(text = element_text(family = "Segoe UI Semilight"))
  return(plot_sensitivity)
}

timestep_sensitivity <- function(lake){
  h2o_bal_default  <- runall_csls_budget(lake, by_gw_iso = TRUE)
  h2o_bal_timestep <- runall_csls_budget(lake, by_gw_iso = FALSE)
  
  h2o_bal_default$static  <- "Default"
  h2o_bal_timestep$static <- "Calendar"
  
  h2o_bal <- rbind(h2o_bal_default, h2o_bal_timestep)
  h2o_bal <- select(h2o_bal, c(date, static, GWin_m3))
  h2o_bal <- h2o_bal[order(h2o_bal$date),]
  h2o_bal <- subset(h2o_bal, is.na(GWin_m3) == FALSE & month(date) != 12)
  
  return(h2o_bal)
}

plot_timestep <- function(lake, h2o_bal) {
  h2o_bal_melt <- melt(h2o_bal, id.vars = c("date", "static"))
  h2o_bal_melt$date <- floor_date(h2o_bal_melt$date, unit = "month")
  plot_sensitivity <- ggplot(data = h2o_bal_melt) +
                      geom_col(aes(x = static, y = value, fill = static)) +
                      facet_wrap(~as.Date(date), scales = "fixed") +
                      scale_y_continuous(expand = c(0,0)) +
                      theme_bw() + 
                      labs(x = "", 
                           y = "GW Inflow (mm)", 
                           title = sprintf("%s Lake", lake)) +
                      guides(fill = FALSE) +
                      theme(text = element_text(family = "Segoe UI Semilight"))
  return(plot_sensitivity)
}
```

## Overview

This Rmarkdown file explores how sensitive the final water balance is to key
choices we've made. These include:

* **Isotope measurements.** How we select which measurmenets to use for a given
month, or how we gap data where no measurements exist.
* **Timesteps.** How to bin our fluxes, whether by calendar month or by one
month ahead of sample date.

## Isotope Measurements

### Upgradient groundwater isotopes (GW)
**No difference**

Our options here are to select "upgradient" wells by:

* gw levels at time of measurement (default)
* static list of "upgradient" wells (**GW**)

Use default. This does not matter much for any of the lakes. Evidently all measured
upgradient wells are sufficiently similar to one another that the selection of
how many to include is minimally important to groundwater inflow calculations.

### Lake isotopes (LK)
**Clear choice**

Our options here are to select lake isotope measurements by:

* a linear interpolation of measured lake isotope values (default)
* assign all dates the value measured during fall turnover (**LK**)

The calculation of groundwater inflow is very sensitive to the choice of lake
isotope measurements at all lakes in the spring and summer months. While the
study was originally designed to use only one fall turnover measurement, based
on our literature review and conversations with Dave Krabbenhoft and Meg
Haserodt at the USGS, it is probably most appropriate to use the measured &
interpolated lake isotope values.

### Precipitation isotopes (KNF, CSLS)
**Choice important, but not clear**

With our own CSLS measurement, we can fill in precipitation measurements by:

* For a month with no precipitation measurement, if the precipitation collector
was active and a measurement was made the next month, backfill to month with no
measurement. (default) 
* Do not backfill, if mising CSLS measurement, just use Kniffin measurement
(**KNF**)

We can also use Maribeth Kniffin's measurements to fill in precipitation
measurements. Our options here are:

* Average in Kniffin measurements for the calendar month (default)
* Use only CSLS measurements (**CSLS**)

Our precipitation approach can affect groundwater inflow measurements by about
20%. The months that are most sensitive to this are October, when precipitation
measurements were taken with a day of lake and groundwater measurements, and
April, when no precipitation measurements were collected until a month later
(May 20).

```{r iso, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 5}
iso_sensitivity("Pleasant")
iso_sensitivity("Long")
iso_sensitivity("Plainfield")
```

## Monthly Timestep
The choice of monthly timestep (one month before sample data, or by calendar
month) does affect groundwater inflow because it changes the weight placed on
isotope measurments. Recall:

\begin{align}
GW_{in} = \frac{P*(\delta^{18}O_{L} - \delta^{18}O_{P}) + E*(\delta^{18}O_{E} - 
          \delta^{18}O_{L})}{\delta^{18}O_{GW_{in}} - \delta^{18}O_{L}}
\end{align}

Given how arbitrary the calendar month is as a window, I'd vote for going with
the window of 1 month before each groundwater sampling date.

```{r timestep, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 5}
lake <- "Pleasant"
h2o_bal <- timestep_sensitivity(lake)
plot_timestep(lake, h2o_bal)

lake <- "Long"
h2o_bal <- timestep_sensitivity(lake)
plot_timestep(lake, h2o_bal)

lake <- "Plainfield"
h2o_bal <- timestep_sensitivity(lake)
plot_timestep(lake, h2o_bal)
```
