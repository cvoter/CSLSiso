---
title: "Isotope Interpretations"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(cslsdata)
library(dplyr) #for pipes, filtering, and selecting
library(stringr) #for str_c
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(knitr)
```

```{r fcns, eval=TRUE, echo=FALSE}
get_dynamic_sites <- function(lake){
  data("weather", package = "cslsdata")
  if (lake == "Pleasant") {
    data("psnt_lst", package = "cslsdata"); lst <- psnt_lst
    data("psnt_isotopes", package = "cslsdata"); isotopes <- psnt_isotopes
    data("psnt_lake_levels", package = "cslsdata"); lake_levels <- psnt_lake_levels
    data("psnt_gw_levels", package = "cslsdata"); gw_levels <- psnt_gw_levels
    data("psnt_stage_vol", package = "cslsdata"); stage_vol <- psnt_stage_vol
    data("psnt_dictionary", package = "cslsdata"); site_dictionary <- psnt_dictionary
  } else if (lake == "Long") {
    data("long_lst", package = "cslsdata"); lst <- long_lst
    data("long_isotopes", package = "cslsdata"); isotopes <- long_isotopes
    data("long_lake_levels", package = "cslsdata"); lake_levels <- long_lake_levels
    data("long_gw_levels", package = "cslsdata"); gw_levels <- long_gw_levels
    data("long_stage_vol", package = "cslsdata"); stage_vol <- long_stage_vol
    data("long_dictionary", package = "cslsdata"); site_dictionary <- long_dictionary
  } else if (lake == "Plainfield") {
    data("pfl_lst", package = "cslsdata"); lst <- pfl_lst
    data("pfl_isotopes", package = "cslsdata"); isotopes <- pfl_isotopes
    data("pfl_lake_levels", package = "cslsdata"); lake_levels <- pfl_lake_levels
    data("pfl_gw_levels", package = "cslsdata"); gw_levels <- pfl_gw_levels
    data("pfl_stage_vol", package = "cslsdata"); stage_vol <- pfl_stage_vol
    data("pfl_dictionary", package = "cslsdata"); site_dictionary <- pfl_dictionary
  }
  
  # Identify monthly timeseries with complete coverage of input data
  timeseries <- find_overlap_timeseries(weather, lst, isotopes, lake_levels,
                                        gw_levels)
  timeseries <- as_datetime(timeseries)

  monthly_isotopes  <- summarise_isotopes(isotopes, site_dictionary, timeseries,
                                        static_gw = FALSE, lake_levels,
                                        gw_levels, 
                                        median_threshold = 0.01,
                                        static_lake= FALSE, 
                                        use_kniffin_pcpn = TRUE)
  monthly_isotopes            <- monthly_isotopes %>%
                                 filter(is.na(.data$GWin_sites) == FALSE &
                                          .data$GWin_sites != "") %>%
                                 select(.data$date, .data$GWin_sites)
  monthly_isotopes$date       <- format(monthly_isotopes$date, "%b %Y")
  upgradient_sites            <- as.data.frame(cbind(monthly_isotopes$date, 
                                                     monthly_isotopes$GWin_sites))
  colnames(upgradient_sites)  <- c("Month", "Upgradient Wells")
  return(upgradient_sites)
}
get_upgradient_sites <- function(lake, site_dictionary){
  if (lake == "Pleasant") {
    data("psnt_dictionary", package = "cslsdata"); site_dictionary <- psnt_dictionary
  } else if (lake == "Long") {
    data("long_dictionary", package = "cslsdata"); site_dictionary <- long_dictionary
  } else if (lake == "Plainfield") {
    data("pfl_dictionary", package = "cslsdata"); site_dictionary <- pfl_dictionary
  }
  upgradient_sites <- site_dictionary %>% 
                      filter(.data$lake == !!lake,
                             .data$static_iso_class == "upgradient") %>%
                      select(.data$static_iso_class,
                             .data$site_id)
  upgradient_sites <- str_c(unique(upgradient_sites$site_id), collapse = ", ")
  return(upgradient_sites)
}

get_water_level_diff <- function(lake){
  if (lake == "Pleasant") {
    data("psnt_lake_levels", package = "cslsdata"); lake_levels <- psnt_lake_levels
    data("psnt_gw_levels", package = "cslsdata"); gw_levels <- psnt_gw_levels
  } else if (lake == "Long") {
    data("long_lake_levels", package = "cslsdata"); lake_levels <- long_lake_levels
    data("long_gw_levels", package = "cslsdata"); gw_levels <- long_gw_levels
  } else if (lake == "Plainfield") {
    data("pfl_lake_levels", package = "cslsdata"); lake_levels <- pfl_lake_levels
    data("pfl_gw_levels", package = "cslsdata"); gw_levels <- pfl_gw_levels
  }
  gw_levels   <- subset_gw_levels(lake, water_levels, site_dictionary)
  lake_levels <- subset_lake_levels(lake, water_levels, site_dictionary)
  for (i in 1:nrow(gw_levels)) {
    today <- gw_levels$date[i]
    gw    <- gw_levels$level_m[i]
    lk    <- lake_levels$level_m[lake_levels$date == today]
    if (length(lk) > 0) {
      gw_levels$diff_m[i] <- gw - lk
    } else {
      gw_levels$diff_m[i] <- NA
    }
  }
  return(gw_levels)
}

```

## Overview

This document is a deeper dive into:

1. How the timing of isotope measurements compares with the daily **water level
difference** between lake and well levels.
2. How isotope measurements at each well plot relative to the **Local Meteoric
Water Line**.
3. How **d18O** measurements, specifically, vary over time at each well.

<br>

When looking at the **water level difference** plots, keep in mind that when the
well plots above the dashed line, it is upgradient of the lake. When it plots
below the dashed line, it is downgradient of the lake. Water level measurements
are shown at a daily timestep. 

To determine if a well is upgradient or downgradient for a given measurement
record, we look at the previous month of daily water level differences. If the
median of these daily differences is less than 1cm (i.e, less than the precision
of HOBO U20 loggers), the isotope measurement is not used. Otherwise, if the
mean of the daily differences is greater than 0, it is considered an upgradient
well.

```{r schematic1, out.width = "75%", eval=TRUE, echo=FALSE, fig.align="center"}
include_graphics(system.file("images", 
                             "water_level_diff.png", 
                             package = "isoH2Obudget", 
                             mustWork = TRUE))
```

<br>

When looking at the **Local Meteoric Water Line** plots, keep in mind that
measurements closest to the meteoric water line are most likely inflowing
groundwater wells while measurements drifting off to the right are likely
outflowing groundwater wells (or the lake itself), which are influenced by
evaporation.

```{r schematic2, out.width = "75%", eval=TRUE, echo=FALSE, fig.align="center"}
include_graphics(system.file("images", 
                             "isotope_signatures.png", 
                             package = "isoH2Obudget", 
                             mustWork = TRUE))
```

## Lakes

### Pleasant Lake
```{r psnt, eval=TRUE, echo=FALSE}
lake = "Pleasant"
upgradient_sites      <- get_upgradient_sites(lake)
data("psnt_isotopes", package = "cslsdata"); lake_isotopes <- psnt_isotopes
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake)
level_plot            <- plot_levels(lake, water_level_diff, lake_isotopes)
iso_plot              <- plot_iso(lake, lake_isotopes)
d18O_plot             <- plot_d18O(lake, lake_isotopes)
```

It looks like most wells at Pleasant Lake have had a consistent relationship
with the lake over time:

 * *Consistently upgradient:* PSNT-01, PSNT-14, PSNT-15, and PSNT-16
 * *Consistently downgradient:* PSNT-03, PSNT-05, PSNT-06, PSNT-07, PSNT-08,
 PSNT-09, PSNT-10
 * *Inconsistent relationship:* PSNT-11
 
Aaron mentioned at an earlier meeting that PSNT-11 may have a well construction
issue which causes it to respond very strongly to precipitation events. We
have removed this well from analysis.

The "upgradient" wells used in the monthly water budget analysis (as determined
by relative lake levels and well levels in the 30 days prior to the measurement)
are:

```{r psnt_iso, eval=TRUE, echo=FALSE}
sites <- get_dynamic_sites(lake)
knitr::kable(sites)
```

```{r psnt_plots, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6, fig.align="center"}
level_plot
iso_plot
d18O_plot
```

### Long Lake
```{r long, eval=TRUE, echo=FALSE}
lake = "Long"
upgradient_sites      <- get_upgradient_sites(lake)
data("long_isotopes", package = "cslsdata"); lake_isotopes <- long_isotopes
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake)
level_plot            <- plot_levels(lake, water_level_diff, lake_isotopes)
iso_plot              <- plot_iso(lake, lake_isotopes)
d18O_plot             <- plot_d18O(lake, lake_isotopes)
```

It looks like there are a few wells that are consistently upgradient of Long
Lake, but classifications are more dynamic here:

 * *Consistently upgradient:* LL-01, LL-06, LL-07, LL-08
 * *Inconsistent relationship:* LL-02, LL-03, LL-04, LL-05
 * *Typically downgradient:* LL-09, LL-10
 
Note that: LL-01B, LL-02B, LL-05C, and LL-09B are deeper wells drilled next to
the shallower monitoring wells. What plots as LL-05 here is called LL-05B in the
DNR water levels database.

The "upgradient" wells used in the monthly water budget analysis (as determined
by relative lake levels and well levels in the 30 days prior to the measurement)
are:

```{r long_iso, eval=TRUE, echo=FALSE}
sites <- get_dynamic_sites(lake)
knitr::kable(sites)
```

```{r long_plots, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6, fig.align="center"}
level_plot
iso_plot
d18O_plot
```


### Plainfield Lake
```{r pfl, eval=TRUE, echo=FALSE}
lake = "Plainfield"
upgradient_sites      <- get_upgradient_sites(lake)
data("pfl_isotopes", package = "cslsdata"); lake_isotopes <- pfl_isotopes
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake)
level_plot            <- plot_levels(lake, water_level_diff, lake_isotopes)
iso_plot              <- plot_iso(lake, lake_isotopes)
d18O_plot             <- plot_d18O(lake, lake_isotopes)
```

As at Long Lake, a few wells are consistently upgradient of Plainfield Lake, but
classifications are more dynamic here:

 * *Consistently upgradient:* PFL-02, PFL-04, PFL-05, PFL-15
 * *Inconsistent relationship:* PFL-07, PFL-13
 * *Typically downgradient:* PFL-03, PFL-09, PFL-11
 * *Consistently downgradient:* PFL-14

The "upgradient" wells used in the monthly water budget analysis (as determined
by relative lake levels and well levels in the 30 days prior to the measurement)
are:

```{r pfl_iso, eval=TRUE, echo=FALSE}
sites <- get_dynamic_sites(lake)
knitr::kable(sites)
```

```{r pfl_plots, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6, fig.align="center"}
level_plot
iso_plot
d18O_plot
```

## Session Info

The version of R and the versions of packages in use when this R Markdown file
was created are listed here:

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
