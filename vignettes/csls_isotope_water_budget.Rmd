---
title: "CSLS Isotope Water Budget"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(cslsdata)
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(dplyr) #for %>% pipes
library(lubridate)
```

## Updates
Updates since last dicussion include:
* **Lake elevation-area-volume relationship incorporated.** Now calculate the
water balance both as a depth (mm) and as a volume (m^3). Dynamic lake surface
area and lake depth is also incorporated into lake ET measurements.
* **Lake surface temperature.** Switch to use hourly HOBO lake surface
temperature, instead of every-other-week field measurements. Used in both the
d18O_evap calculations and lake evaporation calculations. Makes a notable
difference in lake evaporation calculations - lake evaporation drops to nearly
zero (as expected) during ice cover (also now retroactively set lake evaporation
to zero during ice cover).
* **Calculate budget either by calendar month, or by date of isotope measurement.**

## Overview
This water budget model uses stable isotope measurements of precipitation,
evaporation, lake water, and inflowing groundwater as well as observed
precipitation and evaporation rates to calculate monthly groundwater flow into
and out of a lake.

<br>

**Groundwater inflow** is calculated based on Krabbenhoft et al. (1990),
assuming no surface water inputs to the lake:

\begin{align}
\tag{1}
GW_{in} = \frac{P*(\delta^{18}O_{L} - \delta^{18}O_{P}) + E*(\delta^{18}O_{E} - 
          \delta^{18}O_{L})}{\delta^{18}O_{GW_{in}} - \delta^{18}O_{L}}
\end{align}

where $GW_{in}$ is the groundwater inflow (mm), $P$ is precipitation (mm), $E$
is evaporation (mm), and $\delta^{18}O_{x}$ is the relative isotopic composition
in units of per mil relative to a known standard. $\delta^{18}O_{L}$ is measured
at the lake, $\delta^{18}O_{P}$ is measured from precipitation,
$\delta^{18}O_{E}$ is estimated for evaporation, and $\delta^{18}O_{GW_{in}}$ is
measured at inflowing groundwater wells.

<br>

**Groundwater outflow** can then be calculated as the only remaining term in the
water balance:

\begin{align}
\tag{2}
\frac{dV}{dt} = 0 = GW_{in} + P - GW_{out} - E
\end{align}

where $\frac{dV}{dt}$ is the change in lake volume (mm) and $GW_{out}$ is the
groundwater outflow (mm). If changes in lake volume are measured (i.e.,
$\frac{dV}{dt} \neq 0$), then these changes are substituted for 0 and the
modeled groundwater outflows are adjusted.

<br> 

$\delta^{18}O_{E}$ **must be estimated** since it cannot be directly measured
like $\delta^{18}O_{P}$, $\delta^{18}O_{L}$, or $\delta^{18}O_{GW_{in}}$
(Krabbenhoft et al., 1990).
\begin{align}
\tag{3}
\delta^{18}O_{E} = \frac{\alpha * \delta^{18}O_{L} - h*\delta^{18}O_{A} - 
                  \epsilon}{1 - h +10^{-3}\Delta \epsilon}
\end{align}

The relative humidity normalized to the temperature of the surface water (-),
$h$, is calculated as follows:
\begin{align}
\tag{4}
h = \frac{RH}{100}*\frac{es_{A}}{es_{L}}
\end{align}

where $RH$ is the relative humidity (%), $es_{A}$ is the saturated vapor
pressure for the air (kPa), and $es_{L}$ is the saturated vapor pressure for
the lake (kPa). Saturated vapor pressure is calculated based on Allen et al.
(1998) using air temperature (degrees C) or lake temperature (degrees C) for
$t$ as appropriate:
\begin{align}
\tag{5}
es = 0.6108e^{\frac{17.27T}{237 + T}}
\end{align}

The equilibrium isotope fractionation factor (-), $\alpha$, is calculated
based on Ozaydin et al. (2001), where $t$ is the lake surface temperature (K):

\begin{align}
\tag{6}
\alpha &= e^{\frac{-2.0667 - \frac{415.6}{t} + (\frac{1137}{t^2})*10^3}{1000}}
\end{align}

The kinetic fractionation factor (-), $\Delta \epsilon$, is calculated based
on Krabbenhoft et al. (1990):
\begin{align}
\tag{7}
\Delta \epsilon = 14.3*(1 - h)
\end{align}

The total fractionation factor (-), $\epsilon$, combines both the isotopic
fractionation factor and the kinetic fractionation factor (Krabbenhoft et al.,
1990):
\begin{align}
\tag{8}
\epsilon = 1000(1 - \frac{1}{\alpha}) + \Delta \epsilon
\end{align}

Lastly, the isotopic composition of the atmosphere, $\delta^{18}O_{A}$, is
calculated based on Gibson et al. (2016):
\begin{align}
\tag{9}
\delta^{18}O_{A} &= \frac{\delta^{18}O_{P} - k*\epsilonv}{1 + 10^{-3}*k*\epsilon^{+}})
\end{align}

where $k$ can vary from 0.5 for highly seasonal climates to 1.0 for non-seasonal
climates but is set to 1.0 here and $\epsilon^{+}$ is defined as:

\begin{align}
\tag{10}
\epsilon^{+} &= (\alpha - 1)*1000
\end{align}

## Input data
Input data for the Central Sands Lake Study sites (Pleasant Lake, Long Lake, and
Plainfield Lake) are located in the "data" folder of this project, with raw csv
files located in the "inst/extdata" directory. For examples of how to convert
raw csv files into the .Rda inputs required for the functions in this package,
see the vignette "retrieve_csls_inputs_data".

Required inputs include:

### 1. Meteorological Data
For the Central Sands Lake Study (CSLS), hourly air temperature, relative
humidity, precipitation, and reference potential evapotranspiration are
downloaded from the [Hancock Agricultural Research Station
website](https://enviroweather.msu.edu/weather.php?stn=hck). 

```{r weather, eval=TRUE, echo=FALSE}
weather <- cslsdata::weather
head(weather)
```

### 2. Lake Temperature Data
Lake surface temperatures are extracted from the surface-most HOBO sensor with
hourly measurements of vertical lake temperature profiles.

```{r lst, eval=TRUE, echo=FALSE}
lake <- "Pleasant"
lst  <- cslsdata::lst_HOBO[[lake]]
head(lst)
```

### 3. Stable Isotope Measurements
Measurements of $\delta^{18}O_{L}$ and $\delta^{18}O_{GW_{in}}$ are collected on
site for each lake while $\delta^{18}O_{P}$ is measured using samples collected
at the Hancock Research Station. 

```{r isotopes, eval=TRUE, echo=FALSE}
isotopes <- cslsdata::isotopes[[lake]]
head(isotopes)
```

### 4. Lake and Groundwater Levels
Daily lake levels and groundwater levels are retrieved from the DNR Water Use
section ArcGIS feature services. 

```{r water_levels, eval=TRUE, echo=FALSE}
lake_levels <- cslsdata::lake_levels[[lake]]
head(lake_levels)

gw_levels  <- cslsdata::gw_levels[[lake]]
head(gw_levels)
```

### 5. Bathymetry Information
In order to assess potential changes in lake volume, bathymetry information is
also needed. This includes the relationships between elevation, lake volume, and
lake surface area.

```{r stage_vol, eval=TRUE, echo=FALSE}
elev_area_vol <- cslsdata::elev_area_vol[[lake]]
head(elev_area_vol)
```

### 6. Site Dictionary
Lastly, we also need a site dictionary which maps various ID codes for each
measurement site to one another.

```{r site_dict, eval=TRUE, echo=FALSE}
dictionary <- cslsdata::dictionary[[lake]]
head(dictionary)
```

## Analysis
### 1. Subset for lake of interest
First, subset the input data sets for records related to the lake of interest.
In this example, we're using Pleasant Lake.

```{r subset, eval=TRUE, echo=TRUE}
# Identify monthly timeseries with complete coverage of input data
analysis <- find_timeseries(weather, lst, isotopes, lake_levels, gw_levels,
                            dictionary, static_gw = FALSE, threshold = 0.01, 
                            by_gw_iso = TRUE)
```

### 2. Analyze at a monthly timestep
Next, summarize records at a monthly time step. Here, we have **monthly weather**...

```{r monthly_weather, eval=TRUE, echo=FALSE}
monthly_weather <- summarise_weather(weather, lst, elev_area_vol, dictionary,
                                     analysis)
head(monthly_weather)
```

...**monthly lake surface temperature**...

```{r monthly_lst, eval=TRUE, echo=FALSE}
monthly_lst <- summarise_lst(lst, analysis)
head(monthly_lst)
```

...**monthly isotope measurements**, including the calculated
$\delta^{18}O_{E}$...

```{r monthly_isotopes, eval=TRUE, echo=FALSE}
monthly_isotopes <- summarise_isotopes(isotopes, dictionary, analysis,
                                       static_gw = FALSE, lake_levels,
                                       gw_levels)
monthly_isotopes <- summarise_d18O_evap(monthly_weather, monthly_lst,
                                        monthly_isotopes)
monthly_isotopes
```

...**monthly change in lake volume** as a depth (mm)...

```{r monthly_dV, eval=TRUE, echo=FALSE}
monthly_dV <- summarise_dV(lake_levels, analysis)
head(monthly_dV)
```

...and the **monthly water balance**, with all fluxes as a depth (mm).

```{r monthly_h2o_bal, eval=TRUE, echo=FALSE}
monthly_h2o_bal <- runall_csls_budget(lake)
monthly_h2o_bal
```

## Visualization

This gets us to the point where we can visualize the water balance. A few notes:

* **Aug 2019 balance.** Ignore this for now - not enough lake level data to get
good estimates on change in volume, etc. during this time period (only go
through 7/15).
* **Change in Lake Volume.** Proportionally, the changes in lake volume at
Pleasant Lake are much smaller than at Long and Plainfield.
* **Groundwater flow.** At all lakes, groundwater inflow is highest in April and
June of 2019, but groundwater outflow also remains high. September and October are 

### 1. Pleasant Lake

```{r plot, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 4}
monthly_h2o_bal <- monthly_h2o_bal %>%
                   filter(!month(.data$date) %in% c(8, 12))
plot_balance(lake, monthly_h2o_bal, as_vol = TRUE)
```

### 2. Long Lake


```{r long, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 5}
lake = "Long"
monthly_h2o_bal <- runall_csls_budget(lake)
monthly_h2o_bal <- monthly_h2o_bal %>%
                   filter(!month(.data$date) %in% c(8, 12))
plot_balance(lake, monthly_h2o_bal, as_vol = TRUE)
```

### 3. Plainfield Lake

```{r pfl, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 5}
lake = "Plainfield"
monthly_h2o_bal <- runall_csls_budget(lake)
monthly_h2o_bal <- monthly_h2o_bal %>%
                   filter(!month(.data$date) %in% c(8, 12))
plot_balance(lake, monthly_h2o_bal, as_vol = TRUE)
```

## Session Info

The version of R and the versions of packages in use when this R Markdown file
was created are listed here:

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
