---
title: "Isotope Interpretations"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(bit64) #for as.integer64
library(dplyr) #for pipes, filtering, and selecting
library(stringr) #for str_c
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(knitr)
```

```{r fcns, eval=TRUE, echo=FALSE}
get_gw_levels <- function(lake, water_levels, site_dictionary){
  gw_sites <- site_dictionary %>%
              filter(.data$lake == !!lake,
                     .data$obs_type == "GW")
  gw_levels <- water_levels %>%
               filter(.data$site_no %in% c(gw_sites$USGS_id),
                      .data$obs_type == "GW")
  for (i in 1:nrow(gw_levels)) {
    site_no              <- gw_levels$site_no[i]
    site_id              <- as.character(gw_sites$site_id[gw_sites$USGS_id == site_no])
    gw_levels$site_id[i] <- site_id
  }
  
  return(gw_levels)
}

get_lake_levels <- function(lake, water_levels, site_dictionary){
  USGS_id     <- site_dictionary %>%
                 filter(.data$lake == !!lake,
                        .data$obs_type == "LK") %>%
                 select(.data$USGS_id) %>%
                 as.numeric() %>%
                 as.integer64()
  lake_levels <- water_levels %>%
                 filter(.data$site_no == USGS_id,
                        .data$obs_type == "LK")
  return(lake_levels)
}

get_water_level_diff <- function(lake, water_levels, site_dictionary){
  gw_levels   <- get_gw_levels(lake, water_levels, site_dictionary)
  lake_levels <- get_lake_levels(lake, water_levels, site_dictionary)
  for (i in 1:nrow(gw_levels)) {
    today <- gw_levels$date[i]
    gw    <- gw_levels$level_m[i]
    lk    <- lake_levels$level_m[lake_levels$date == today]
    if (length(lk) > 0) {
      gw_levels$diff_m[i] <- gw - lk
    } else {
      gw_levels$diff_m[i] <- NA
    }
  }
  return(gw_levels)
}

```

```{r data, eval=TRUE, echo=FALSE}
data("isotopes")
data("water_levels")
data("site_dictionary")
```

## Updates
Updates since last dicussion include:

* **Redefined static upgradient wells** for use in static approach to
classifying upgradient vs. downgradients wells based on which wells are most
consistently upgradient over the current timeseries.

## Overview
When looking at these plots, keep in mind that measurements closest to the
meteoric water line are most likely inflowing groundwater wells while
measurements drifting off to the right are likely outflowing groundwater wells
(or the lake itself), which are influenced by evaporation.

```{r schematic, out.width = "75%", eval=TRUE, echo=FALSE, fig.align="center"}
include_graphics(system.file("images", 
                             "isotope_signatures.png", 
                             package = "isoH2Obudget", 
                             mustWork = TRUE))
```

## Pleasant Lake
```{r psnt_upgradient, eval=TRUE, echo=FALSE}
lake = "Pleasant"

upgradient_sites <- site_dictionary %>% 
                    filter(.data$lake == !!lake,
                           .data$static_iso_class == "upgradient") %>%
                    select(.data$static_iso_class,
                           .data$site_id)
upgradient_sites <- str_c(unique(upgradient_sites$site_id), collapse = ", ")
```

When well classification is **static**, the only **upgradient** wells used are: **`r upgradient_sites`** 

Aaron mentioned at an earlier meeting that PSNT-11 (and maybe PSNT-06?) may have
well construction issues which cause them to respond very strongly to
precipitation events.

It looks like most wells at Pleasant Lake have had a consistent relationship
with the lake over time:

 * **Consistently upgradient:** PSNT-01, PSNT-14, PSNT-15, and PSNT-16
 * **Consistently downgradient:** PSNT-03, PSNT-05, PSNT-06, PSNT-07, PSNT-08,
 PSNT-09, PSNT-10
 * **Inconsistent relationship:** PSNT-11

```{r psnt, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6, fig.align="center"}
lake = "Pleasant"

lake_isotopes         <- isotopes %>% 
                         filter(lake == !!lake | site_id == "PRECIP")
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake, water_levels, site_dictionary)

plot_levels <- ggplot() +
               geom_hline(yintercept = 0,
                          linetype = "dashed") +
               geom_line(data = water_level_diff,
                         aes(x = date, y = diff_m)) +
               geom_point(data = lake_isotopes,
                          aes(x = date, y = diff_m, fill = d18O),
                          shape = 21,
                          size = 3,
                          color = "black") +
               scale_fill_distiller(name = "d18O",
                                    palette = "RdYlBu",
                                    direction = 1) +
               facet_wrap(~site_id) +
               labs(x = "", y = "GW Level (m) - Lake Level (m)") +
               theme_bw() +
               theme(text = element_text(family = "Segoe UI Semilight"),
                     panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(),
                     legend.position = "top")
              
plot_levels

facet_plot <- ggplot(data = lake_isotopes,
                    aes(x = d18O, y = d2H, group = site_id))
facet_plot <- plot_facet(facet_plot, df = lake_isotopes)
facet_plot

```

## Long Lake
```{r ll_upgradient, eval=TRUE, echo=FALSE}
lake = "Long"

upgradient_sites <- site_dictionary %>% 
                    filter(.data$lake == !!lake,
                           .data$static_iso_class == "upgradient") %>%
                    select(.data$static_iso_class,
                           .data$site_id)
upgradient_sites <- str_c(unique(upgradient_sites$site_id), collapse = ", ")
```

When well classification is **static**, the only **upgradient** wells used are: **`r upgradient_sites`** 

For Long Lake, I need to straighten out which wells with water level records are
being sampled for isotopes for: LL-01, LL-02, LL-05, and LL-09.

```{r long, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=8, fig.align="center"}
lake = "Long"

lake_isotopes         <- isotopes %>% 
                         filter(lake == !!lake | site_id == "PRECIP")
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake, water_levels, site_dictionary)

plot_levels <- ggplot() +
               geom_hline(yintercept = 0,
                          linetype = "dashed") +
               geom_line(data = water_level_diff,
                         aes(x = date, y = diff_m)) +
               geom_point(data = lake_isotopes,
                          aes(x = date, y = diff_m, fill = d18O),
                          shape = 21,
                          size = 3,
                          color = "black") +
               scale_fill_distiller(name = "d18O",
                                    palette = "RdYlBu",
                                    direction = 1) +
               facet_wrap(~site_id) +
               labs(x = "", y = "GW Level (m) - Lake Level (m)") +
               theme_bw() +
               theme(text = element_text(family = "Segoe UI Semilight"),
                     panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(),
                     legend.position = "top")
              
plot_levels

facet_plot <- ggplot(data = lake_isotopes,
                    aes(x = d18O, y = d2H, group = site_id))
facet_plot <- plot_facet(facet_plot, df = lake_isotopes)
facet_plot

```


## Plainfield Lake
```{r pfl_upgradient, eval=TRUE, echo=FALSE}
lake = "Plainfield"

upgradient_sites <- site_dictionary %>% 
                    filter(.data$lake == !!lake,
                           .data$static_iso_class == "upgradient") %>%
                    select(.data$static_iso_class,
                           .data$site_id)
upgradient_sites <- str_c(unique(upgradient_sites$site_id), collapse = ", ")
```

When well classification is **static**, the only **upgradient** wells used are: **`r upgradient_sites`** 

```{r pfl, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6, fig.align="center"}
lake = "Plainfield"

lake_isotopes         <- isotopes %>% 
                         filter(lake == !!lake | site_id == "PRECIP")
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake, water_levels, site_dictionary)

plot_levels <- ggplot() +
               geom_hline(yintercept = 0,
                          linetype = "dashed") +
               geom_line(data = water_level_diff,
                         aes(x = date, y = diff_m)) +
               geom_point(data = lake_isotopes,
                          aes(x = date, y = diff_m, fill = d18O),
                          shape = 21,
                          size = 3,
                          color = "black") +
               scale_fill_distiller(name = "d18O",
                                    palette = "RdYlBu",
                                    direction = 1) +
               facet_wrap(~site_id) +
               labs(x = "", y = "GW Level (m) - Lake Level (m)") +
               theme_bw() +
               theme(text = element_text(family = "Segoe UI Semilight"),
                     panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(),
                     legend.position = "top")
              
plot_levels

facet_plot <- ggplot(data = lake_isotopes,
                    aes(x = d18O, y = d2H, group = site_id))
facet_plot <- plot_facet(facet_plot, df = lake_isotopes)
facet_plot

```

## Session Info

The version of R and the versions of packages in use when this R Markdown file
was created are listed here:

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
