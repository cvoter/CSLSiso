---
title: "Isotope Interpretations"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(bit64) #for as.integer64
library(dplyr) #for pipes, filtering, and selecting
library(stringr) #for str_c
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(knitr)
```

```{r fcns, eval=TRUE, echo=FALSE}
get_dynamic_sites <- function(lake, site_dictionary, lst, isotopes, 
                                  water_levels, stage_vol){
  lk               <- subset_lake(lake, site_dictionary, lst, isotopes, 
                                  water_levels, stage_vol)
  monthly_isotopes <- get_monthly_isotopes(lk$isotopes, lk$site_dictionary, 
                                           static_wells = FALSE, lk$lake_levels, 
                                           lk$gw_levels, Xday = 7, 
                                           static_lake = FALSE)
  monthly_isotopes            <- monthly_isotopes %>%
                                 filter(is.na(.data$GWin_sites) == FALSE &
                                          .data$GWin_sites != "") %>%
                                 select(.data$date, .data$GWin_sites)
  monthly_isotopes$date       <- as.character(monthly_isotopes$date)
  monthly_isotopes$GWin_sites <- unlist(monthly_isotopes$GWin_sites)
  upgradient_sites            <- str_c(monthly_isotopes$date, 
                                       monthly_isotopes$GWin_sites, 
                                       sep = ": ")
  return(upgradient_sites)
}
get_upgradient_sites <- function(lake, site_dictionary){
  upgradient_sites <- site_dictionary %>% 
                      filter(.data$lake == !!lake,
                             .data$static_iso_class == "upgradient") %>%
                      select(.data$static_iso_class,
                             .data$site_id)
  upgradient_sites <- str_c(unique(upgradient_sites$site_id), collapse = ", ")
  return(upgradient_sites)
}

get_water_level_diff <- function(lake, water_levels, site_dictionary){
  gw_levels   <- subset_gw_levels(lake, water_levels, site_dictionary)
  lake_levels <- subset_lake_levels(lake, water_levels, site_dictionary)
  for (i in 1:nrow(gw_levels)) {
    today <- gw_levels$date[i]
    gw    <- gw_levels$level_m[i]
    lk    <- lake_levels$level_m[lake_levels$date == today]
    if (length(lk) > 0) {
      gw_levels$diff_m[i] <- gw - lk
    } else {
      gw_levels$diff_m[i] <- NA
    }
  }
  return(gw_levels)
}

```

```{r data, eval=TRUE, echo=FALSE}
data("lst")
data("isotopes")
data("water_levels")
data("site_dictionary")
data("stage_vol")
```

## Updates
Updates since last discussion include:
 * **Timeseries of d18O**. Added a timeseries plot of d18O for each site, as in
 Krabbenhoft paper.

## Issues
Current issues include:

 * **Pleasant Lake PSNT-11.** While this technically meets the threshold for an
 upgradient well frequently, it's pretty much right at the lake level and
 behaves much more like the lake. According to Aaron, the well construction
 might be faulty on this well. **To Do:** Remove this from analysis.
 * **Dynamic Well Classification.** With PSNT-11 removed, all other wells at all
 other lakes seem legit. Suggest retaining dynamic classification approach for
 upgradient/downgradient wells. **To Do:** Adjust averageing rules. Increase to
 30 days, consider how consistently the well is in a single category during that
 time (e.g., what percent of time it is in one category, or how many times it
 flips categories). Start with calendar year month, but may be more accurate to
 count one month back from sampling date.
 * **Precipitation Isotopes.** Use Maribeth's values in addition to CSLS values.
 * **Long Lake Wells.** There are more Long Lake monitoring wells in the DNR
 database than are used for monitoring, and they have confusing names like
 "LL-05B" and "LL-05C". Need to dig deeper and maybe talk with Bob to make sure
 I'm only using the wells associated with well chemistry measurements.

## Overview

When looking at the **water level difference** plots, keep in mind that when the
well plots above the dashed line, it is upgradient of the lake. When it plots
below the dashed line, it is downgradient of the lake. Water level measurements
are shown at a daily timestep.

```{r schematic1, out.width = "75%", eval=TRUE, echo=FALSE, fig.align="center"}
include_graphics(system.file("images", 
                             "water_level_diff.png", 
                             package = "isoH2Obudget", 
                             mustWork = TRUE))
```

<br>

When looking at the **isotope** plots, keep in mind that measurements closest to
the meteoric water line are most likely inflowing groundwater wells while
measurements drifting off to the right are likely outflowing groundwater wells
(or the lake itself), which are influenced by evaporation.

```{r schematic2, out.width = "75%", eval=TRUE, echo=FALSE, fig.align="center"}
include_graphics(system.file("images", 
                             "isotope_signatures.png", 
                             package = "isoH2Obudget", 
                             mustWork = TRUE))
```

## Pleasant Lake
```{r psnt, eval=TRUE, echo=FALSE}
lake = "Pleasant"
upgradient_sites      <- get_upgradient_sites(lake, site_dictionary)
lake_isotopes         <- subset_isotopes(lake, isotopes)
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake, water_levels, site_dictionary)
level_plot            <- plot_levels(lake, water_level_diff, lake_isotopes)
iso_plot              <- plot_iso(lake, lake_isotopes)
d18O_plot             <- plot_d18O(lake, lake_isotopes)
```

It looks like most wells at Pleasant Lake have had a consistent relationship
with the lake over time:

 * *Consistently upgradient:* PSNT-01, PSNT-14, PSNT-15, and PSNT-16
 * *Consistently downgradient:* PSNT-03, PSNT-05, PSNT-06, PSNT-07, PSNT-08,
 PSNT-09, PSNT-10
 * *Inconsistent relationship:* PSNT-11
 
Aaron mentioned at an earlier meeting that PSNT-11 may have a well construction
issue which causes it to respond very strongly to precipitation events. We
should probably remove this well from analysis.

Currently, when well classification is **static**, the only upgradient wells
used are: **`r upgradient_sites`**. We could likely add PSNT-01, PSNT-14, and
PSNT-15 to this list.

When well classification is **dynamic**, the upgradient wells each month are:
```{r psnt_iso, eval=TRUE, echo=FALSE}
get_dynamic_sites(lake, site_dictionary, lst, isotopes, water_levels, stage_vol)
```

```{r psnt_plots, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6, fig.align="center"}
level_plot
iso_plot
d18O_plot
```

## Long Lake
```{r long, eval=TRUE, echo=FALSE}
lake = "Long"
upgradient_sites      <- get_upgradient_sites(lake, site_dictionary)
lake_isotopes         <- subset_isotopes(lake, isotopes)
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake, water_levels, site_dictionary)
level_plot            <- plot_levels(lake, water_level_diff, lake_isotopes)
iso_plot              <- plot_iso(lake, lake_isotopes)
d18O_plot             <- plot_d18O(lake, lake_isotopes)
```

It looks like there are a few wells that are consistently upgradient of Long
Lake, but classifications are more dynamic here:

 * *Consistently upgradient:* LL-01, LL-06, LL-07, LL-08
 * *Inconsistent relationship:* LL-02, LL-03, LL-04, LL-05
 * *Typically downgradient:* LL-09, LL-10
 
I need to straighten out which wells with water level records are being sampled
for isotopes for: LL-01, LL-02, LL-05, and LL-09.

Currently, when well classification is **static**, the only upgradient wells
used are: **`r upgradient_sites`**. We could likely add LL-01 and LL-08 to this
list.

When well classification is **dynamic**, the upgradient wells each month are:
```{r long_iso, eval=TRUE, echo=FALSE}
get_dynamic_sites(lake, site_dictionary, lst, isotopes, water_levels, stage_vol)
```

```{r long_plots, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6, fig.align="center"}
level_plot
iso_plot
d18O_plot
```


## Plainfield Lake
```{r pfl, eval=TRUE, echo=FALSE}
lake = "Plainfield"
upgradient_sites      <- get_upgradient_sites(lake, site_dictionary)
lake_isotopes         <- subset_isotopes(lake, isotopes)
lake_isotopes$diff_m  <- 0
water_level_diff      <- get_water_level_diff(lake, water_levels, site_dictionary)
level_plot            <- plot_levels(lake, water_level_diff, lake_isotopes)
iso_plot              <- plot_iso(lake, lake_isotopes)
d18O_plot             <- plot_d18O(lake, lake_isotopes)
```

As at Long Lake, a few wells are consistently upgradient of Plainfield Lake, but
classifications are more dynamic here:

 * *Consistently upgradient:* PFL-02, PFL-04, PFL-05, PFL-15
 * *Inconsistent relationship:* PFL-07, PFL-13
 * *Typically downgradient:* PFL-03, PFL-09, PFL-11
 * *Consistently downgradient:* PFL-14

Currently, when well classification is **static**, the only upgradient wells
used are: **`r upgradient_sites`**. We could likely add PFL-04 to this list.

When well classification is **dynamic**, the upgradient wells each month are:
```{r pfl_iso, eval=TRUE, echo=FALSE}
get_dynamic_sites(lake, site_dictionary, lst, isotopes, water_levels, stage_vol)
```

```{r pfl_plots, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6, fig.align="center"}
level_plot
iso_plot
d18O_plot
```

## Session Info

The version of R and the versions of packages in use when this R Markdown file
was created are listed here:

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
