---
title: "CSLS Isotope Water Budget"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=TRUE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
```

## Overview
This water budget model uses stable isotope measurements of precipitation,
evaporation, lake water, and inflowing groundwater as well as observed
precipitation and evaporation rates to calculate monthly groundwater flow into
and out of a lake.

<br>

**Groundwater inflow** is calculated as follows (Krabbenhoft et al., 1990):

\begin{align}
\tag{1}
GW_{in} = \frac{P*(\delta^{18}O_{L} - \delta^{18}O_{P}) + E*(\delta^{18}O_{E} - 
          \delta^{18}O_{L})}{\delta^{18}O_{GW_{in}} - \delta^{18}O_{L}}
\end{align}

where $GW_{in}$ is the groundwater inflow [L^3/T], $P$ is precipitation [L^3/T],
$E$ is evaporation [L^3/T], and $\delta^{18}O_{x}$ is the relative isotopic
composition in units of per mil relative to a known standard. The relative
isotopic composition is defined as $\delta^{18}O_{x} = [\frac{R_{x}}{R_{std}} -
1] * 10^{3}$ where $R_{x}$ is the ratio of isotope concentrations (e.g.,
$\frac{^{18}O}{^{16}O}$). $\delta^{18}O_{L}$ is measured at the lake,
$\delta^{18}O_{P}$ is measured from precipitation, $\delta^{18}O_{E}$ is
estimated for evaporation, and $\delta^{18}O_{GW_{in}}$ is measured at inflowing
groundwater wells.

<br>

**Groundwater outflow** can then be calculated from the following equation
(Krabbenhoft et al., 1990):

\begin{align}
\tag{2}
\frac{dV}{dt} = 0 = GW_{in} + P - GW_{out} - E
\end{align}

where $\frac{dV}{dt}$ is the change in lake volume [L^3/T] and $GW_{out}$ is the
groundwater outflow [L^3/T]. If changes in lake volume are measured (i.e.,
$\frac{dV}{dt} \neq 0$), then these changes are substituted for 0 and the
modeled groundwater outflows are adjusted.

<br>

$\delta^{18}O_{E}$ **must be estimated** as follows (Krabbenhoft et al., 1990)
since it cannot be directly measured like $\delta^{18}O_{P}$,
$\delta^{18}O_{L}$, or $\delta^{18}O_{GW_{in}}$.

\begin{align}
\tag{3}
\delta^{18}O_{E} = \frac{\alpha * \delta^{18}O_{L} - h*\delta^{18}O_{A} - 
                  \epsilon}{1 - h +10^{-3}\Delta \epsilon}
\end{align}

The terms of Eq. 3 are calculated using the following definitions (Krabbenhoft
et al., 1990; Ozaydin et al., 2001):

\begin{align}
\tag{4}
\alpha &= \frac{-2.0667 - \frac{415.6}{t} + (\frac{1137}{t^2})*10^3}{1000} \\
\tag{5}
h &= RH*\frac{es_{A}}{es_{L}} \\
\tag{6}
es &= \frac{1321.7e^{\frac{17.27t}{237}+t}}{273+t} \\
\tag{7}
\delta^{18}O_{A} &= \frac{\delta^{18}O_{P}}{\alpha} - (1 - \frac{1}{\alpha}) \\
\tag{8}
\epsilon &= 1000(1 - \alpha) + \Delta \epsilon \\
\tag{9}
\Delta \epsilon &= 14.3*(1 - h)
\end{align}

where $t$ is air temperature (K) for $\alpha$ and $es_{A}$, $t$ is lake
temperature (K) for $es_{L}$, and $RH$ is relative humidity.

## Input data
Input data for the Central Sands Lake Study sites (Pleasant Lake, Long Lake, and
Plainfield Lake) are located in the "inst/extdata" folder of this project.
Required inputs include:

* Monthly mean air temperature (K)
* Monthly mean relative humidity (%)
* Monthly precipitation depth (mm)
* Monthly reference potential evapotranspiration depths (mm)
* Monthly mean lake surface temperature (K)
* Regular (e.g., monthly or every-other-month) stable isotope measurements of
$\delta^{18}O_{L}$, $\delta^{18}O_{GW_{in}}$, and $\delta^{18}O_{P}$

### 1. Meteorological Data
For the Central Sands Lake Study (CSLS), daily or subdaily air temperature,
relative humidity, precipitation, and reference potential evapotranspiration are
downloaded from the [Hancock Agricultural Research Station
website](https://enviroweather.msu.edu/weather.php?stn=hck) (station id: hck).
This weather station is located in Hancock, WI (location: 44.1188, -89.533,
elevation: 241m), approximately 8 miles from Plainfield Lake, 8.5 miles from
Long Lake, and 14.5 miles from Pleasant Lake.

On the Hancock Station website, click on "Weather Station at Hancock" or "More
weather for this station" to be routed to a page with options for "Custom
Reports (Data-on-Demand)". Select Data Type "Daily Data" or "Hourly Data", then
check (Max/Min) Air Temperature [1.5m], Precipitation, (Max/Min) Relative
Humidity [1.5m], and Reference Potential Evapotranspiration. Select starting
date and end date, display units (metric), and output (csv), then "Generate
Report". Note that the earliest starting date allowed (as of January and
September 2019) is February 15, 2018.

Daily or subdaily data is summarized at a monthly timestep.

```{r monthly_weather, eval=TRUE, echo=TRUE}
monthly_weather <- get_monthly_weather(filename = 'weather_hancock_hourly_2019_09_06.csv',
                                       filedir = 'system.file',
                                       skip_lines = 7,
                                       daily_weather = FALSE)
head(monthly_weather)
```

### 2. Lake Temperature Data
Lake surface temperatures (at 0 meters) are extracted from every-other-week
measurements of vertical lake temperature profiles taken at the CSLS Lakes.

Field data is stored in [WDNR
SWIMS](https://dnr.wi.gov/topic/surfacewater/swims/) and is associated with the
project "Central Sands Lake Study" or "csls".

Every-other-week measurements is summarized at a monthly timestep.

```{r monthly_lst, eval=TRUE, echo=TRUE}
monthly_lst <- get_monthly_lst(filename = 'SWIMS_2019_09_05.csv',
                               filedir = 'system.file',
                               wbic = 106900)
head(monthly_lst)
```

### 3. Stable Isotope Measurements
Measurements of $\delta^{18}O_{L}$ and $\delta^{18}O_{GW_{in}}$ are collected on
site for each lake while $\delta^{18}O_{P}$ is measured using samples collected
at the Hancock Research Station.

Measurements are summarized at a monthly timestep. Site types (precipitation,
lake, inflowing groundwtaer well, or outflowing groundwater well) are defined in
the "sites_file" csv file.

```{r monthly_isotopes, eval=TRUE, echo=TRUE}
monthly_isotopes <- get_monthly_isotopes(isotope_file = 'isotope_samples_2019_09_06.csv',
                                 sites_file = 'isotope_sites_pleasant_2019_09_06.csv',
                                 filedir = 'system.file')
head(monthly_isotopes)
```

## Analysis
### 1. Estimate d18O Evaporation
As the only isotopic parameter that cannot be directly measured,
$\delta^{18}O_{E}$ must be calculated next. 

```{r add_d18O_E, eval=TRUE, echo=TRUE}
monthly_isotopes <- get_monthly_d18O_evap(monthly_weather,
                                          monthly_lst,
                                          monthly_isotopes)
head(monthly_isotopes)
```

### 2. Calculate Water Balance
```{r h2o_bal, eval=TRUE, echo=TRUE}
lake_h2o_bal <- get_monthly_h2o_bal(monthly_weather, monthly_isotopes)
head(lake_h2o_bal)
```

## Results
Currently, only one month has isotope measurements for precipitation, the lake,
and groundwater wells at Pleasant Lake, so only that one month can be
visualized.

```{r plot, eval=TRUE, echo=TRUE}

melted_bal <- melt(lake_h2o_bal, id.vars = "date")
for (i in 1:nrow(melted_bal)) {
  if (melted_bal$variable[i] == "P" |
  melted_bal$variable[i] == "GWin") {
    melted_bal$in_or_out[i] <- "in"
  } else {
    melted_bal$in_or_out[i] <- "out"
  }
}

plot_bal <- subset(melted_bal, date == melted_bal$date[2])

plot_balance <- ggplot(data = plot_bal) +
                geom_col(aes(x = in_or_out, y = value, fill = variable)) +
                facet_wrap(~date) +
                scale_y_continuous(expand = c(0,0)) +
                theme_bw()
  
plot_balance

```

## References

## Session Info

The version of R and the versions of packages in use when this R Markdown file
was created are listed here:

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
