---
title: "CSLS Isotope Water Budget"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(qpdf) #for pdf size reduction
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(dplyr) #for %>% pipes
```

## Issues
Current issues with ths approach include:

* **Hancock weather station** has NAs for temperature, relative humidity, and
reference potential evapotranspiration for several days in May - July 2019.
    - Currently, I use hourly data to minimize the impact of this. 
    - What are the modelers doing?
* **Stable isotope measurements** don't align with one another.
    - When can lake measurmente be used for other months?
    - Can precipitaiton be used across multiple months (seems like no)?
    - Perhaps we should just grab the closest precip & lake measurment for each
    well sample?
* **The total fractionation factor**, $\epsilon$, is confusing to me based on
Justin P.'s spreadsheet.
    - Word document + Krabbenhoft paper use $\alpha$ in equation
    - Excel spreadsheet inexplicably changes this to $\frac{1}{\alpha}$
    - One possible explanation is that $\alpha*$ means $\frac{1}{\alpha}$, but
    if so, that is not explained and is inconsistently applied to equations
    - Makes a big difference in outcome.
* **Changes in lake volume** are not necessarily 0 throughout the month. Neither are
surface inputs necessarily 0 (that would indicate absolutely no watershed).
* **Inflowing vs. outflowing** groundwater wells change over time. Currently,
type of well is hardwired in to the "sites_type" csv file. Should update this
after exploring well level records & isotope composition over time.

## Overview
This water budget model uses stable isotope measurements of precipitation,
evaporation, lake water, and inflowing groundwater as well as observed
precipitation and evaporation rates to calculate monthly groundwater flow into
and out of a lake.

<br>

**Groundwater inflow** is calculated based on Krabbenhoft et al. (1990),
assuming no surface water inputs to the lake:

\begin{align}
\tag{1}
GW_{in} = \frac{P*(\delta^{18}O_{L} - \delta^{18}O_{P}) + E*(\delta^{18}O_{E} - 
          \delta^{18}O_{L})}{\delta^{18}O_{GW_{in}} - \delta^{18}O_{L}}
\end{align}

where $GW_{in}$ is the groundwater inflow (mm), $P$ is precipitation (mm), $E$
is evaporation (mm), and $\delta^{18}O_{x}$ is the relative isotopic composition
in units of per mil relative to a known standard. $\delta^{18}O_{L}$ is measured
at the lake, $\delta^{18}O_{P}$ is measured from precipitation,
$\delta^{18}O_{E}$ is estimated for evaporation, and $\delta^{18}O_{GW_{in}}$ is
measured at inflowing groundwater wells.

<br>

**Groundwater outflow** can then be calculated as the only remaining term in the
water balance:

\begin{align}
\tag{2}
\frac{dV}{dt} = 0 = GW_{in} + P - GW_{out} - E
\end{align}

where $\frac{dV}{dt}$ is the change in lake volume (mm) and $GW_{out}$ is the
groundwater outflow (mm). If changes in lake volume are measured (i.e.,
$\frac{dV}{dt} \neq 0$), then these changes are substituted for 0 and the
modeled groundwater outflows are adjusted.

<br> 

$\delta^{18}O_{E}$ **must be estimated** since it cannot be directly measured
like $\delta^{18}O_{P}$, $\delta^{18}O_{L}$, or $\delta^{18}O_{GW_{in}}$
(Krabbenhoft et al., 1990).
\begin{align}
\tag{3}
\delta^{18}O_{E} = \frac{\alpha * \delta^{18}O_{L} - h*\delta^{18}O_{A} - 
                  \epsilon}{1 - h +10^{-3}\Delta \epsilon}
\end{align}

The relative humidity normalized to the temperature of the surface water (-),
$h$, is calculated as follows:
\begin{align}
\tag{4}
h = \frac{RH}{100}*\frac{es_{A}}{es_{L}}
\end{align}

where $RH$ is the relative humidity (%), $es_{A}$ is the saturated vapor
pressure for the air (kPa), and $es_{L}$ is the saturated vapor pressure for
the lake (kPa). Saturated vapor pressure is calculated based on Allen et al.
(1998) using air temperature (degrees C) or lake temperature (degrees C) for
$t$ as appropriate:
\begin{align}
\tag{5}
es = 0.6108e^{\frac{17.27t}{237+t}}
\end{align}

The equilibrium isotope fractionation factor (-), $\alpha$, is calculated
based on Ozaydin et al. (2001), where $t$ is the lake surface temperature (K):

\begin{align}
\tag{6}
\alpha &= e^{\frac{-2.0667 - \frac{415.6}{t} + (\frac{1137}{t^2})*10^3}{1000}}
\end{align}

The kinetic fractionation factor (-), $\Delta \epsilon$, is calculated based
on Krabbenhoft et al. (1990):
\begin{align}
\tag{7}
\Delta \epsilon = 14.3*(1 - h)
\end{align}

The total fractionation factor (-), $\epsilon$, combines both the isotopic
fractionation factor and the kinetic fracitonation factor (Krabbenhoft et al.,
1990):
\begin{align}
\tag{8}
\epsilon = 1000(1 - \frac{1}{\alpha}) + \Delta \epsilon
\end{align}

Lastly, the isotopic composition of the atmosphere, $\delta^{18}O_{A}$, is
calculated based on Ozaydin et al. (2001):
\begin{align}
\tag{9}
\delta^{18}O_{A} = \frac{\delta^{18}O_{P}}{\alpha} - (1 - \frac{1}{\alpha})
\end{align}


## Input data
Input data for the Central Sands Lake Study sites (Pleasant Lake, Long Lake, and
Plainfield Lake) are located in the "data" folder of this project, with raw csv
files located in the "inst/extdata" directory. For examples of how to convert
raw csv files into the .Rda inputs required for the functions in this package,
see the vignette "retrieve_csls_inputs_data".

Required inputs include:

### 1. Meteorological Data
For the Central Sands Lake Study (CSLS), hourly air temperature, relative
humidity, precipitation, and reference potential evapotranspiration are
downloaded from the [Hancock Agricultural Research Station
website](https://enviroweather.msu.edu/weather.php?stn=hck) (station id: hck).
This weather station is located in Hancock, WI (location: 44.1188, -89.533,
elevation: 241m), approximately 8 miles from Plainfield Lake, 8.5 miles from
Long Lake, and 14.5 miles from Pleasant Lake.

On the Hancock Station website, click on "Weather Station at Hancock" or "More
weather for this station" to be routed to a page with options for "Custom
Reports (Data-on-Demand)". Select Data Type "Daily Data" or "Hourly Data", then
check (Max/Min) Air Temperature [1.5m], Precipitation, (Max/Min) Relative
Humidity [1.5m], and Reference Potential Evapotranspiration. Select starting
date and end date, display units (metric), and output (csv), then "Generate
Report". Note that the earliest starting date allowed (as of January and
September 2019) is February 15, 2018.

```{r weather, eval=TRUE, echo=FALSE}
load("../data/weather.Rda")
head(weather)
```

### 2. Lake Temperature Data
Lake surface temperatures (at 0 meters) are extracted from every-other-week
measurements of vertical lake temperature profiles taken at the CSLS Lakes.

Field data is stored in [WDNR
SWIMS](https://dnr.wi.gov/topic/surfacewater/swims/) and is associated with the
project "Central Sands Lake Study" or "csls".

```{r lst, eval=TRUE, echo=FALSE}
load("../data/lst.Rda")
head(lst)
```

### 3. Stable Isotope Measurements
Measurements of $\delta^{18}O_{L}$ and $\delta^{18}O_{GW_{in}}$ are collected on
site for each lake while $\delta^{18}O_{P}$ is measured using samples collected
at the Hancock Research Station.

```{r isotopes, eval=TRUE, echo=FALSE}
load("../data/isotopes.Rda")
head(isotopes)
```

### 4. Lake and Groundwater Levels
Daily lake levels and groundwater levels are retrieved from the DNR Water Use
section ArcGIS feature services. The data of interest for CSLS is DG_HiCap >
DG_CSLS_QUANT_MON_WTM_EXT > Layer 2 (W13101.WU_CSLS_QUANT_DATA).

```{r water_levels, eval=TRUE, echo=FALSE}
load("../data/water_levels.Rda")
head(water_levels)
```

### 5. Bathymetry Information
In order to assess potential changes in lake volume, bathymetry information is
also needed. This includes the relationships between elevation, lake volume, and
lake surface area.

```{r stage_vol, eval=TRUE, echo=FALSE}
load("../data/stage_vol.Rda")
head(stage_vol)
```

### 6. Site Dictionary
Lastly, we also need a site dictionary which maps various ID codes for each
measurement site to one another.

```{r site_dict, eval=TRUE, echo=FALSE}
load("../data/site_dictionary.Rda")
head(site_dictionary)
```

## Analysis
### 1. Subset for lake of interest
First, subset the input data sets for records related to the lake of interest.

```{r subset, eval=TRUE, echo=FALSE}
# Subset for lake
lake_subset <- subset_lake(lake = "Pleasant",
                           site_dictionary,
                           lst,
                           isotopes,
                           water_levels,
                           stage_vol)

# Reassign variable names
lst             <- lake_subset$lst
isotopes        <- lake_subset$isotopes
lake_levels     <- lake_subset$lake_levels
gw_levels       <- lake_subset$gw_levels
stage_vol       <- lake_subset$stage_vol
site_dictionary <- lake_subset$site_dictionary

# Identify monthly timeseries wiht complete coverage of input data
month_info      <- get_overlap_months(weather, 
                                      lst, 
                                      isotopes, 
                                      lake_levels, 
                                      gw_levels)
```

### 2. Analyze at a monthly timestep
Next, summarize records at a monthly time step. Here, we have monthly weather...

```{r monthly_weather, eval=TRUE, echo=TRUE}
monthly_weather   <- get_monthly_weather(weather)
head(monthly_weather)
```

...monthly lake surface temperature...

```{r monthly_lst, eval=TRUE, echo=TRUE}
monthly_lst       <- get_monthly_lst(lst)
head(monthly_lst)
```

...monthly isotope measurements (& calculations)...

```{r monthly_isotopes, eval=TRUE, echo=TRUE}
monthly_isotopes  <- get_monthly_isotopes(isotopes, site_dictionary,
                                          static_wells = FALSE, lake_levels, 
                                          gw_levels, Xday = 7, 
                                          static_lake = FALSE)
monthly_isotopes  <- get_monthly_d18O_evap(monthly_weather,
                                           monthly_lst,
                                           monthly_isotopes)
monthly_isotopes
```

...monthly change in lake volume (mm)...

```{r monthly_dV, eval=TRUE, echo=TRUE}
monthly_dV        <- get_monthly_dV(lake_levels,
                                    stage_vol, 
                                    month_info, 
                                    as_depth = TRUE,
                                    tmp_depth_fix = TRUE)
head(monthly_dV)
```

...and the monthly water balance.

```{r monthly_h2o_bal, eval=TRUE, echo=TRUE}
monthly_h2o_bal   <- get_monthly_h2o_bal(monthly_weather,
                                         monthly_isotopes,
                                         monthly_dV,
                                         month_info)
monthly_h2o_bal
```

### 3. Visualize water balance

```{r plot, eval=TRUE, echo=FALSE, fig.width = 5, fig.height = 3}

melted_bal <- melt(subset(monthly_h2o_bal, is.na(GWout) == FALSE), id.vars = "date")
for (i in 1:nrow(melted_bal)) {
  if (melted_bal$variable[i] == "P" |
  melted_bal$variable[i] == "GWin") {
    melted_bal$in_or_out[i] <- "In"
  } else {
    melted_bal$in_or_out[i] <- "Out"
  }
}

plot_balance <- ggplot(data = melted_bal) +
                geom_col(aes(x = in_or_out, y = value, fill = variable)) +
                facet_wrap(~date) +
                scale_y_continuous(expand = c(0,0)) +
                scale_fill_brewer(name = "Flux",
                                  palette = "Paired",
                                  breaks = c("P","E","GWin","GWout","dV"),
                                  labels = c("Precipitation",
                                             "Evapotranspiration",
                                             "Groundwater Inflow",
                                             "Groundwater Outflow",
                                             "Change in Lake Volume")) +
                labs(x = "", y = "Flux (mm)") +
                theme_bw() + 
                theme(text = element_text(family = "Segoe UI Semilight"))
  
plot_balance

```

## Session Info

The version of R and the versions of packages in use when this R Markdown file
was created are listed here:

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
