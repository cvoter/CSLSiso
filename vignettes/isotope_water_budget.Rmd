---
title: "CSLS Isotope Water Budget"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(devtools)
library(isoH2Obudget)
library(reshape2) #for melting
library(ggplot2) #for plotting
library(extrafont) #for fonts
library(dplyr) #for %>% pipes
```

## Issues
Current issues with ths approach include:

* **Stable isotope measurements** See new vignette for sensitivity analysis.
Availability of precip isotope measurements is the limiting factor for monthly
water balance calculations.
* **Lake stage-volume relationship** is not quite right. 
    * Volume represents losing lake water from the outside in, rather than top
    down.
    * Due to irregularity of lake bed, estimating volume as surface area of
    contor * 0.5ft contour interval is super off.
    * For water budget purposes, it's probably better to just use lake levels
    (m) anyway. But will need to go back to ArcGIS if need stage-vol
    relationship for other purposes.

## Updates
Updates since last dicussion include:

* **Hancock weather station** NAs are now linearly interpolated between values.
This works fine for current timeseries gaps, but should probably add in warnings
if gaps are super long (>> 8 hrs).
* **The total fractionation factor**, $\epsilon$, is fixed. $\alpha*$ means
$\frac{1}{\alpha}$ everywhere now.
* **Groundwater isotope measurements**. Code now dynamically adjusts upgradient
vs. downgradient classification for each measurement (default behavior), but can
also switch to use static classifications.
* **Precipitation isotope measurements**. Currently backfill up to one month of
NAs with next month's value. This works for current measurements, but may not
always be appropriate. Should make this a more robust process at somepoint.
* **Lake isotope measurements**. Code uses measured isotopes by default, but can
also switch to use static classifictaion (mean of fall measurements, Sept-Nov).
* **Changes in lake volume** are incorporated into water balance. Currently does
this just with lake levels, see issue above.

## Overview
This water budget model uses stable isotope measurements of precipitation,
evaporation, lake water, and inflowing groundwater as well as observed
precipitation and evaporation rates to calculate monthly groundwater flow into
and out of a lake.

<br>

**Groundwater inflow** is calculated based on Krabbenhoft et al. (1990),
assuming no surface water inputs to the lake:

\begin{align}
\tag{1}
GW_{in} = \frac{P*(\delta^{18}O_{L} - \delta^{18}O_{P}) + E*(\delta^{18}O_{E} - 
          \delta^{18}O_{L})}{\delta^{18}O_{GW_{in}} - \delta^{18}O_{L}}
\end{align}

where $GW_{in}$ is the groundwater inflow (mm), $P$ is precipitation (mm), $E$
is evaporation (mm), and $\delta^{18}O_{x}$ is the relative isotopic composition
in units of per mil relative to a known standard. $\delta^{18}O_{L}$ is measured
at the lake, $\delta^{18}O_{P}$ is measured from precipitation,
$\delta^{18}O_{E}$ is estimated for evaporation, and $\delta^{18}O_{GW_{in}}$ is
measured at inflowing groundwater wells.

<br>

**Groundwater outflow** can then be calculated as the only remaining term in the
water balance:

\begin{align}
\tag{2}
\frac{dV}{dt} = 0 = GW_{in} + P - GW_{out} - E
\end{align}

where $\frac{dV}{dt}$ is the change in lake volume (mm) and $GW_{out}$ is the
groundwater outflow (mm). If changes in lake volume are measured (i.e.,
$\frac{dV}{dt} \neq 0$), then these changes are substituted for 0 and the
modeled groundwater outflows are adjusted.

<br> 

$\delta^{18}O_{E}$ **must be estimated** since it cannot be directly measured
like $\delta^{18}O_{P}$, $\delta^{18}O_{L}$, or $\delta^{18}O_{GW_{in}}$
(Krabbenhoft et al., 1990).
\begin{align}
\tag{3}
\delta^{18}O_{E} = \frac{\alpha * \delta^{18}O_{L} - h*\delta^{18}O_{A} - 
                  \epsilon}{1 - h +10^{-3}\Delta \epsilon}
\end{align}

The relative humidity normalized to the temperature of the surface water (-),
$h$, is calculated as follows:
\begin{align}
\tag{4}
h = \frac{RH}{100}*\frac{es_{A}}{es_{L}}
\end{align}

where $RH$ is the relative humidity (%), $es_{A}$ is the saturated vapor
pressure for the air (kPa), and $es_{L}$ is the saturated vapor pressure for
the lake (kPa). Saturated vapor pressure is calculated based on Allen et al.
(1998) using air temperature (degrees C) or lake temperature (degrees C) for
$t$ as appropriate:
\begin{align}
\tag{5}
es = 0.6108e^{\frac{17.27T}{237 + T}}
\end{align}

The equilibrium isotope fractionation factor (-), $\alpha$, is calculated
based on Ozaydin et al. (2001), where $t$ is the lake surface temperature (K):

\begin{align}
\tag{6}
\alpha &= e^{\frac{-2.0667 - \frac{415.6}{t} + (\frac{1137}{t^2})*10^3}{1000}}
\end{align}

The kinetic fractionation factor (-), $\Delta \epsilon$, is calculated based
on Krabbenhoft et al. (1990):
\begin{align}
\tag{7}
\Delta \epsilon = 14.3*(1 - h)
\end{align}

The total fractionation factor (-), $\epsilon$, combines both the isotopic
fractionation factor and the kinetic fractionation factor (Krabbenhoft et al.,
1990):
\begin{align}
\tag{8}
\epsilon = 1000(1 - \frac{1}{\alpha}) + \Delta \epsilon
\end{align}

Lastly, the isotopic composition of the atmosphere, $\delta^{18}O_{A}$, is
calculated based on Gibson et al. (2016):
\begin{align}
\tag{9}
\delta^{18}O_{A} &= \frac{\delta^{18}O_{P} - k*\epsilonv}{1 + 10^{-3}*k*\epsilon^{+}})
\end{align}

where $k$ can vary from 0.5 for highly seasonal climates to 1.0 for non-seasonal
climates but is set to 1.0 here and $\epsilon^{+}$ is defined as:

\begin{align}
\tag{10}
\epsilon^{+} &= (\alpha - 1)*1000
\end{align}

## Input data
Input data for the Central Sands Lake Study sites (Pleasant Lake, Long Lake, and
Plainfield Lake) are located in the "data" folder of this project, with raw csv
files located in the "inst/extdata" directory. For examples of how to convert
raw csv files into the .Rda inputs required for the functions in this package,
see the vignette "retrieve_csls_inputs_data".

Required inputs include:

### 1. Meteorological Data
For the Central Sands Lake Study (CSLS), hourly air temperature, relative
humidity, precipitation, and reference potential evapotranspiration are
downloaded from the [Hancock Agricultural Research Station
website](https://enviroweather.msu.edu/weather.php?stn=hck). 

See also: "?retrieve_csls_weather" and "?weather"

```{r weather, eval=TRUE, echo=FALSE}
data(weather)
head(weather)
```

### 2. Lake Temperature Data
Lake surface temperatures (at 0 meters) are extracted from every-other-week
measurements of vertical lake temperature profiles taken at the CSLS Lakes. 

See also: "?retrieve_csls_lst" and "?lst"

```{r lst, eval=TRUE, echo=FALSE}
data(lst)
head(lst)
```

### 3. Stable Isotope Measurements
Measurements of $\delta^{18}O_{L}$ and $\delta^{18}O_{GW_{in}}$ are collected on
site for each lake while $\delta^{18}O_{P}$ is measured using samples collected
at the Hancock Research Station. 

See also: "?retrieve_csls_isotopes" and "?isotopes"

```{r isotopes, eval=TRUE, echo=FALSE}
data(isotopes)
head(isotopes)
```

### 4. Lake and Groundwater Levels
Daily lake levels and groundwater levels are retrieved from the DNR Water Use
section ArcGIS feature services. 

See also: "?retrieve_csls_water_levels" and "?water_levels"

```{r water_levels, eval=TRUE, echo=FALSE}
data(water_levels)
head(water_levels)
```

### 5. Bathymetry Information
In order to assess potential changes in lake volume, bathymetry information is
also needed. This includes the relationships between elevation, lake volume, and
lake surface area. **Note:** The stage-volume relationship in the current csv
export from ArcGIS does not look right, so this is not currently being used
(only lake levels are used to get change in lake volume as a depth).

See also: "?retrieve_csls_stage_vol" and "?stage_vol"

```{r stage_vol, eval=TRUE, echo=FALSE}
data(stage_vol)
head(stage_vol)
```

### 6. Site Dictionary
Lastly, we also need a site dictionary which maps various ID codes for each
measurement site to one another.

See also: "?retrieve_csls_site_dictionary" and "the dataset "?site_dictionary"

```{r site_dict, eval=TRUE, echo=FALSE}
data(site_dictionary)
head(site_dictionary)
```

## Analysis
### 1. Subset for lake of interest
First, subset the input data sets for records related to the lake of interest.
In this example, we're using Pleasant Lake.

```{r subset, eval=TRUE, echo=TRUE}
# Subset for lake
lake_subset <- subset_lake(lake = "Pleasant",
                           site_dictionary,
                           lst,
                           isotopes,
                           water_levels,
                           stage_vol)

# Reassign variable names
lst             <- lake_subset$lst
isotopes        <- lake_subset$isotopes
lake_levels     <- lake_subset$lake_levels
gw_levels       <- lake_subset$gw_levels
stage_vol       <- lake_subset$stage_vol
site_dictionary <- lake_subset$site_dictionary

# Identify monthly timeseries with complete coverage of input data
month_info      <- get_overlap_months(weather, 
                                      lst, 
                                      isotopes, 
                                      lake_levels, 
                                      gw_levels)
```

### 2. Analyze at a monthly timestep
Next, summarize records at a monthly time step. Here, we have **monthly weather**...

```{r monthly_weather, eval=TRUE, echo=FALSE}
monthly_weather   <- get_monthly_weather(weather, lst, stage_vol, site_dictionary)
head(monthly_weather)
```

...**monthly lake surface temperature**...

```{r monthly_lst, eval=TRUE, echo=FALSE}
monthly_lst       <- get_monthly_lst(lst)
head(monthly_lst)
```

...**monthly isotope measurements**, including the calculated
$\delta^{18}O_{E}$...

```{r monthly_isotopes, eval=TRUE, echo=FALSE}
monthly_isotopes  <- get_monthly_isotopes(isotopes, site_dictionary,
                                          static_wells = FALSE, lake_levels, 
                                          gw_levels, median_threshold = 0.01, 
                                          static_lake = FALSE)
monthly_isotopes  <- get_monthly_d18O_evap(monthly_weather,
                                           monthly_lst,
                                           monthly_isotopes)
monthly_isotopes
```

...**monthly change in lake volume** as a depth (mm)...

```{r monthly_dV, eval=TRUE, echo=FALSE}
monthly_dV        <- get_monthly_dV(lake_levels, month_info)
head(monthly_dV)
```

...and the **monthly water balance**, with all fluxes as a depth (mm).

```{r monthly_h2o_bal, eval=TRUE, echo=FALSE}
monthly_h2o_bal   <- get_monthly_h2o_bal(monthly_weather,
                                         monthly_isotopes,
                                         monthly_dV,
                                         month_info)
monthly_h2o_bal
```

## Visualization

This gets us to the point where we can visualize the water balance, at least for
the months with complete input data. 

**Groundwater flow-through** is much higher at all lakes during the spring than
in the fall, presumably due to spring melt. Spring flow-through is highest at
Plainfield Lake, which also has the highest change in lake volume. It is lowest
at Long Lake. Does Long Lake have lower hydraulic conductivities?

**Evapotranspiration** is higher in spring thatn in the fall as well. This is
possible, but I'd like to look into the reference potential ET calculated by
Hancock to make sure it's appropriate for a water body. My understanding of
reference ET is that it usually most closely represents a tall grass, and
conversions are needed to make it appropriate for other landscapes.

Side note: Ideally, I'd like to get the change in lake volume to plot on top of
ET and GWout, but that's a non-trivial change that's a lower priority right now.

### 1. Pleasant Lake

```{r plot, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 4}

melted_bal <- melt(subset(monthly_h2o_bal, is.na(GWout) == FALSE), id.vars = "date")
for (i in 1:nrow(melted_bal)) {
  if (melted_bal$variable[i] == "P" |
  melted_bal$variable[i] == "GWin") {
    melted_bal$in_or_out[i] <- "In"
  } else {
    melted_bal$in_or_out[i] <- "Out"
  }
}

plot_balance <- ggplot(data = melted_bal) +
                geom_col(aes(x = in_or_out, y = value, fill = variable)) +
                facet_wrap(~date) +
                scale_y_continuous(expand = c(0,0)) +
                scale_fill_brewer(name = "Flux",
                                  palette = "Paired",
                                  breaks = c("P","E","GWin","GWout","dV"),
                                  labels = c("Precipitation",
                                             "Evapotranspiration",
                                             "Groundwater Inflow",
                                             "Groundwater Outflow",
                                             "Change in Lake Volume")) +
                labs(x = "", y = "Flux (mm)", title = "Pleasant Lake") +
                theme_bw() + 
                theme(text = element_text(family = "Segoe UI Semilight"))
  
plot_balance

```

### 2. Long Lake


```{r long, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 5}
# Data
data(weather)
data(lst)
data(isotopes)
data(water_levels)
data(site_dictionary)
data(stage_vol)

# Subset for lake
lake_subset <- subset_lake(lake = "Long", site_dictionary, lst, isotopes, water_levels, stage_vol)

# Reassign variable names
lst             <- lake_subset$lst
isotopes        <- lake_subset$isotopes
lake_levels     <- lake_subset$lake_levels
gw_levels       <- lake_subset$gw_levels
stage_vol       <- lake_subset$stage_vol
site_dictionary <- lake_subset$site_dictionary

# Identify monthly timeseries with complete coverage of input data
month_info      <- get_overlap_months(weather, lst, isotopes, lake_levels, gw_levels)

# Monthly summary
monthly_weather   <- get_monthly_weather(weather, lst, stage_vol, site_dictionary)
monthly_lst       <- get_monthly_lst(lst)
monthly_dV        <- get_monthly_dV(lake_levels, month_info)
monthly_isotopes  <- get_monthly_isotopes(isotopes, site_dictionary,
                                          static_wells = FALSE, lake_levels, 
                                          gw_levels, median_threshold = 0.01, 
                                          static_lake = FALSE)
monthly_isotopes  <- get_monthly_d18O_evap(monthly_weather, monthly_lst, monthly_isotopes)
monthly_h2o_bal   <- get_monthly_h2o_bal(monthly_weather, monthly_isotopes, monthly_dV, month_info)

# Plot
melted_bal <- melt(subset(monthly_h2o_bal, is.na(GWout) == FALSE), id.vars = "date")

for (i in 1:nrow(melted_bal)) {
  if (melted_bal$variable[i] == "P" |
  melted_bal$variable[i] == "GWin") {
    melted_bal$in_or_out[i] <- "In"
  } else {
    melted_bal$in_or_out[i] <- "Out"
  }
}

plot_balance <- ggplot(data = melted_bal) +
                geom_col(aes(x = in_or_out, y = value, fill = variable)) +
                facet_wrap(~date) +
                scale_y_continuous(expand = c(0,0)) +
                scale_fill_brewer(name = "Flux",
                                  palette = "Paired",
                                  breaks = c("P","E","GWin","GWout","dV"),
                                  labels = c("Precipitation",
                                             "Evapotranspiration",
                                             "Groundwater Inflow",
                                             "Groundwater Outflow",
                                             "Change in Lake Volume")) +
                labs(x = "", y = "Flux (mm)", title = "Long Lake") +
                theme_bw() + 
                theme(text = element_text(family = "Segoe UI Semilight"))
  
plot_balance
```

### 3. Plainfield Lake

```{r pfl, eval=TRUE, echo=FALSE, fig.width = 7, fig.height = 5}
# Data
data(weather)
data(lst)
data(isotopes)
data(water_levels)
data(site_dictionary)
data(stage_vol)

# Subset for lake
lake_subset <- subset_lake(lake = "Plainfield", site_dictionary, lst, isotopes, water_levels, stage_vol)

# Reassign variable names
lst             <- lake_subset$lst
isotopes        <- lake_subset$isotopes
lake_levels     <- lake_subset$lake_levels
gw_levels       <- lake_subset$gw_levels
stage_vol       <- lake_subset$stage_vol
site_dictionary <- lake_subset$site_dictionary

# Identify monthly timeseries with complete coverage of input data
month_info      <- get_overlap_months(weather, lst, isotopes, lake_levels, gw_levels)

# Monthly summary
monthly_weather   <- get_monthly_weather(weather, lst, stage_vol, site_dictionary)
monthly_lst       <- get_monthly_lst(lst)
monthly_dV        <- get_monthly_dV(lake_levels, month_info)
monthly_isotopes  <- get_monthly_isotopes(isotopes, site_dictionary,
                                          static_wells = FALSE, lake_levels, 
                                          gw_levels, median_threshold = 0.01, 
                                          static_lake = FALSE)
monthly_isotopes  <- get_monthly_d18O_evap(monthly_weather, monthly_lst, monthly_isotopes)
monthly_h2o_bal   <- get_monthly_h2o_bal(monthly_weather, monthly_isotopes, monthly_dV, month_info)

# Plot
melted_bal <- melt(subset(monthly_h2o_bal, is.na(GWout) == FALSE), id.vars = "date")

for (i in 1:nrow(melted_bal)) {
  if (melted_bal$variable[i] == "P" |
  melted_bal$variable[i] == "GWin") {
    melted_bal$in_or_out[i] <- "In"
  } else {
    melted_bal$in_or_out[i] <- "Out"
  }
}

plot_balance <- ggplot(data = melted_bal) +
                geom_col(aes(x = in_or_out, y = value, fill = variable)) +
                facet_wrap(~date) +
                scale_y_continuous(expand = c(0,0)) +
                scale_fill_brewer(name = "Flux",
                                  palette = "Paired",
                                  breaks = c("P","E","GWin","GWout","dV"),
                                  labels = c("Precipitation",
                                             "Evapotranspiration",
                                             "Groundwater Inflow",
                                             "Groundwater Outflow",
                                             "Change in Lake Volume")) +
                labs(x = "", y = "Flux (mm)", title = "Plainfield Lake") +
                theme_bw() + 
                theme(text = element_text(family = "Segoe UI Semilight"))
  
plot_balance

```

## Session Info

The version of R and the versions of packages in use when this R Markdown file
was created are listed here:

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
